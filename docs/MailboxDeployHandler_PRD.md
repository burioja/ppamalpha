# MailboxDeployHandler PRD (Product Requirements Document)

## 📋 개요

### 제품명
우편함 배포 핸들러 (MailboxDeployHandler)

### 버전
1.0.0

### 작성일
2025-10-23

### 목적
지도에서 롱프레스로 우편함 배포를 시작할 때 필요한 주소 확인, 거리 검증, 사용자 인터랙션을 처리하는 핸들러

---

## 🎯 비즈니스 요구사항

### 핵심 가치
- **정확성**: 올바른 위치에 포스트 배포 보장
- **사용성**: 직관적인 주소 확인 프로세스
- **보안**: 허용된 거리 내에서만 배포 허용
- **효율성**: 빠른 주소 조회 및 검증

### 비즈니스 목표
1. 사용자가 의도한 정확한 위치에 포스트 배포
2. 무단 배포 방지 (거리 제한)
3. 사용자 타입별 차별화된 배포 권한 제공
4. 원활한 배포 프로세스 경험 제공

---

## 👥 사용자 스토리

### 일반 사용자
```
As a 일반 사용자,
I want 내 집이나 일터 근처 1km 이내에서만 포스트를 배포할 수 있도록 하고,
So that 내가 관리할 수 있는 범위 내에서만 포스트를 배포할 수 있다.
```

### 슈퍼사이트 사용자
```
As a 슈퍼사이트 사용자,
I want 더 넓은 범위(3km)에서 포스트를 배포할 수 있도록 하고,
So that 더 많은 지역을 커버하며 포스트를 배포할 수 있다.
```

### 모든 사용자
```
As a 사용자,
I want 롱프레스한 위치가 정확한지 확인할 수 있도록 하고,
So that 실수로 잘못된 위치에 포스트를 배포하지 않을 수 있다.
```

---

## 🔧 기능 요구사항

### 1. 주소 조회 기능
- **설명**: 롱프레스한 좌표를 실제 주소로 변환
- **우선순위**: 높음
- **기술적 요구사항**:
  - Nominatim API 사용
  - 에러 처리 (API 실패 시 좌표값 표시)
  - 비동기 처리

### 2. 주소 확인 다이얼로그
- **설명**: 사용자에게 조회된 주소가 맞는지 확인
- **우선순위**: 높음
- **UI 요구사항**:
  - AlertDialog 형태
  - "예", "아니오" 버튼
  - 조회된 건물명 표시
- **사용자 경험**:
  - 직관적인 확인 프로세스
  - 취소 가능

### 3. 주소 검색 기능 (미구현)
- **설명**: 주소가 틀렸을 때 대안 주소 검색
- **우선순위**: 중간
- **상태**: TODO
- **예상 기능**:
  - 주소 검색 다이얼로그
  - 검색 결과 선택
  - 좌표와 건물명 반환

### 4. 거리 검증 기능
- **설명**: 배포 위치가 허용 범위 내인지 확인
- **우선순위**: 높음
- **검증 기준**:
  - 현재 위치
  - 집 위치
  - 일터 위치들
- **거리 제한**:
  - 일반 사용자: 1km
  - 슈퍼사이트: 3km

### 5. 에러 처리
- **설명**: 검증 실패 시 사용자에게 알림
- **우선순위**: 높음
- **표시 방법**: SnackBar
- **메시지**: 거리 제한 안내

---

## 🎨 사용자 인터페이스

### 주소 확인 다이얼로그
```
┌─────────────────────────────────┐
│ 이 위치가 맞습니까?              │
├─────────────────────────────────┤
│ [조회된 건물명]                  │
│                                 │
│              [아니오] [예]      │
└─────────────────────────────────┘
```

### 에러 메시지
```
┌─────────────────────────────────┐
│ 이 위치에는 포스트를 배포할 수   │
│ 없습니다.                       │
│ 1km 이내의 주소에서 선택해주세요.│
└─────────────────────────────────┘
```

---

## 🔄 사용자 플로우

### 정상 플로우
1. **지도 롱프레스** → 좌표 획득
2. **건물명 조회** → Nominatim API 호출
3. **주소 확인** → 사용자 확인 다이얼로그
4. **거리 검증** → 허용 범위 확인
5. **배포 화면** → PostDeployScreen 이동

### 대안 플로우 (주소 틀림)
1. **지도 롱프레스** → 좌표 획득
2. **건물명 조회** → Nominatim API 호출
3. **주소 확인** → "아니오" 선택
4. **주소 검색** → (미구현) 대안 주소 선택
5. **거리 검증** → 허용 범위 확인
6. **배포 화면** → PostDeployScreen 이동

### 에러 플로우
1. **지도 롱프레스** → 좌표 획득
2. **건물명 조회** → Nominatim API 호출
3. **주소 확인** → 사용자 확인
4. **거리 검증** → 거리 초과
5. **에러 메시지** → SnackBar 표시
6. **프로세스 종료**

---

## 🛠 기술적 요구사항

### 의존성
- **Flutter**: UI 프레임워크
- **latlong2**: 거리 계산
- **NominatimService**: 역지오코딩

### 성능 요구사항
- **API 응답 시간**: 3초 이내
- **다이얼로그 표시**: 즉시
- **거리 계산**: 100ms 이내

### 에러 처리
- **API 실패**: 좌표값으로 대체
- **Context disposed**: 조기 종료
- **네트워크 오류**: 기본값 반환

### 보안 요구사항
- **거리 검증**: 필수 (클라이언트 사이드)
- **사용자 타입 확인**: 서버 사이드 검증 필요

---

## 📊 성공 지표

### 기능적 지표
- **주소 조회 성공률**: 95% 이상
- **거리 검증 정확도**: 100%
- **사용자 취소율**: 10% 이하

### 사용자 경험 지표
- **다이얼로그 응답 시간**: 2초 이내
- **에러 발생률**: 5% 이하
- **사용자 만족도**: 4.0/5.0 이상

---

## 🚧 알려진 제한사항

### 현재 미구현 기능
1. **주소 검색 다이얼로그**: 사용자가 주소를 직접 검색할 수 없음
2. **다국어 지원**: 한국어만 지원
3. **오프라인 모드**: 네트워크 연결 필수

### 기술적 제한사항
1. **Nominatim API 의존성**: 외부 서비스 의존
2. **클라이언트 사이드 검증**: 서버 사이드 이중 검증 필요
3. **좌표 정확도**: GPS 정확도에 의존

---

## 🔮 향후 개선 계획

### 단기 (1-2개월)
1. **주소 검색 다이얼로그 구현**
2. **에러 메시지 개선**
3. **로딩 상태 표시**

### 중기 (3-6개월)
1. **다국어 지원**
2. **오프라인 모드**
3. **주소 즐겨찾기 기능**

### 장기 (6개월+)
1. **AI 기반 주소 추천**
2. **실시간 거리 업데이트**
3. **배치 배포 기능**

---

## 📝 구현 상태

### ✅ 완료된 기능
- [x] 건물명 조회 (Nominatim API)
- [x] 주소 확인 다이얼로그
- [x] 거리 검증 로직
- [x] 사용자 타입별 거리 제한
- [x] 에러 처리 및 메시지
- [x] PostDeployScreen 네비게이션

### 🚧 진행 중인 기능
- 없음

### ❌ 미구현 기능
- [ ] 주소 검색 다이얼로그
- [ ] 다국어 지원
- [ ] 오프라인 모드

---

## 📞 연락처

### 개발팀
- **담당자**: 개발팀
- **이메일**: dev@company.com
- **슬랙**: #ppam-dev

### 문서 관리
- **최종 수정**: 2025-10-23
- **다음 리뷰**: 2025-11-23
- **버전**: 1.0.0
