# 251003 업데이트 진행사항

## 작업 일자
2025년 10월 3일

## 업데이트 개요
PPAM Alpha 앱의 통계, 지갑, 검색, 내 플레이스, 맵 기능 개선 및 성능 최적화

---

## 1. 배포 통계 대시보드 개선

### 변경 전
- 배포 탭에 기본 통계만 표시 (총/활성/삭제/총리워드)
- 시각화 부족

### 변경 후
- 새로운 `DeploymentStatisticsDashboardScreen` 생성
- 다양한 그래프로 시각화:
  - 스토어별 포스트 개수 (파이 차트)
  - 시계열별 포스트 배포/수집 (선 그래프)
  - 시계열별 리워드 지급 (막대 그래프)
  - 사용자별 수집 통계 (히스토그램)
- 대시보드 형태의 종합 통계 페이지

### 수정 파일
- 생성: `lib/features/post_system/screens/deployment_statistics_dashboard_screen.dart`

### 진행 상태
- [x] 화면 구조 설계
- [x] 데이터 조회 로직 구현
- [x] 그래프 위젯 구현 (파이/선/막대 차트)
- [ ] 라우팅 연결 (app_routes.dart에 경로 미등록)

---

## 2. 포스트별 통계 페이지 개선

### 변경 전
- 스토어 중심 뷰
- 주소 정보 부족

### 변경 후
- 포스트 중심 뷰로 재구성
- 스토어 주소 검색 기반으로 변경
- 지도에 스토어 위치 표시
- 포스트와 스토어 연결 강화

### 수정 파일
- 수정: `lib/features/post_system/screens/post_statistics_screen.dart`
- 수정: `lib/features/place_system/screens/create_place_screen.dart`

### 진행 상태
- [ ] 화면 레이아웃 수정 (보류)
- [ ] 주소 검색 기능 통합 (보류)
- [ ] 지도 위젯 추가 (보류 - Phase 4에서 구현 예정)

---

## 3. 지갑 기능 개선

### 변경 전
- 3개 탭: 포인트/이미지/회수한전단지
- 이미지, 회수한 전단지는 레거시 기능

### 변경 후
- 2개 탭: 포인트/포인트 통계
- 이미지, 회수한 전단지 탭 제거
- 포인트 충전 버튼 UI 추가 (기능 미구현)
- 포인트 통계 화면 추가

### 수정 파일
- 수정: `lib/features/user_dashboard/screens/wallet_screen.dart`

### 진행 상태
- [x] TabController length 3 → 2 변경
- [x] 이미지/회수한전단지 관련 코드 제거
- [x] 포인트 통계 탭 구현
- [x] 포인트 충전 버튼 UI 추가

---

## 4. 검색 기능 개선

### 변경 전
- 예산 검색 기능 포함
- 홈 아이콘 없음

### 변경 후
- 예산 검색 기능 제거
- 내 플레이스로 이동하는 홈 아이콘 추가
- SearchScreen UI 개선

### 수정 파일
- 수정: `lib/features/user_dashboard/screens/search_screen.dart`

### 진행 상태
- [x] 예산 아이콘 삭제 (main_screen.dart:219-231 삭제 완료)
- [x] 홈 아이콘 추가
- [x] 내 플레이스 네비게이션 연결
- [ ] 검색 기능 구현 (UI만 존재, 실제 검색 로직 미구현)

---

## 5. 내 플레이스 개선

### 변경 전
- 리스트만 표시
- 카테고리가 텍스트로 표시
- 주소 검증 없음
- 쿠폰 암호 설정 필수

### 변경 후
- 상단에 지도 위젯 추가 (높이: 80-100px)
- 플레이스 위치를 지도에 마커로 표시
- 카테고리를 아이콘으로 표시
- 주소 검증 로직 추가 (검색 기반 주소만 유효)
- 쿠폰 암호 설정을 옵션으로 변경

### 수정 파일
- 수정: `lib/features/place_system/screens/my_places_screen.dart`
- 수정: `lib/features/place_system/screens/edit_place_screen.dart`
- 수정: `lib/features/place_system/screens/place_detail_screen.dart`

### 진행 상태
- [x] 상단 지도 위젯 추가 (100px 높이)
- [x] 플레이스 마커 표시 (카테고리별 아이콘)
- [x] 카테고리 아이콘 매핑 (플레이스명 앞 아이콘으로 표시)
- [x] 주소 검증 로직 추가 (검색 기반 주소만 유효, 회원가입 방식 적용)
- [ ] 쿠폰 설정 옵션화 (create_place에 체크박스 있으나 저장 로직 미연결)

---

## 6. 성능 최적화

### 변경 전
- 메인 스크린에서 포인트를 지나치게 자주 로드
- 화면 전환마다 포인트 로드 로그 출력

### 변경 후
- 포인트 변경 시에만 리로드
- 불필요한 디버그 로그 제거/조건화
- 메모리 사용 최적화

### 수정 파일
- 수정: `lib/features/user_dashboard/screens/main_screen.dart`

### 진행 상태
- [x] 포인트 로드 로직 최적화 (5분 쿨다운 적용)
- [x] 디버그 로그 조건화 (kDebugMode 사용)
- [x] 메모리 누수 확인

---

## 13. 맵 기능 개선

### A. 맵 줌인 한계치 조정

#### 변경 전
- maxZoom: 16.0

#### 변경 후
- maxZoom: 17.0
- 더 세밀한 줌인 가능 (1단계 추가)

#### 수정 위치
- `lib/features/map_system/screens/map_screen.dart:2539` (MapOptions)
- `lib/features/map_system/screens/map_screen.dart:2586` (TileLayer)

#### 진행 상태
- [x] MapOptions maxZoom 16.0 → 17.0 변경
- [x] TileLayer maxZoom 16.0 → 17.0 변경

---

### B. Mock 위치 이동 거리 조정

#### 변경 전
- 이동 거리: 0.001도 (약 111m)

#### 변경 후
- 이동 거리: 0.000225도 (약 25m)
- 더 정밀한 위치 조정 가능

#### 수정 위치
- `lib/features/map_system/screens/map_screen.dart:2417`

#### 수정 내용
```dart
// Before
const double moveDistance = 0.001; // 약 100m 정도 이동

// After
const double moveDistance = 0.000225; // 약 25m 이동
```

#### 진행 상태
- [x] moveDistance 상수 변경

---

### C. 내 포스트 필터 버튼 수정

#### 문제 원인
- FilterChip의 onSelected가 `_updateMarkers()`만 호출
- `_updateMarkers()`는 클러스터링만 다시 하고 서버에서 데이터를 다시 가져오지 않음
- 필터 상태만 변경되고 실제 필터링이 안 됨

#### 해결 방법
- `_updateMarkers()` 대신 `_updatePostsBasedOnFogLevel()` 호출
- 서버에서 필터가 적용된 데이터를 다시 가져옴

#### 필터링 기준 (데이터베이스 쿼리)
```dart
// lib/features/map_system/services/markers/marker_service.dart:218-221
if (filters['myPostsOnly'] == true && user != null) {
  query = query.where('creatorId', isEqualTo: user.uid);
  print('서버사이드 필터: 내 포스트만 조회 (creatorId: ${user.uid})');
}
```

- 컬렉션: `markers`
- 필드: `creatorId`
- 조건: 현재 사용자 UID와 일치

#### 수정 위치
- `lib/features/map_system/screens/map_screen.dart:2735`

#### 수정 내용
```dart
// Before
onSelected: (selected) {
  setState(() {
    _showMyPostsOnly = selected;
    if (selected) _showCouponsOnly = false;
  });
  _updateMarkers();
},

// After
onSelected: (selected) {
  setState(() {
    _showMyPostsOnly = selected;
    if (selected) _showCouponsOnly = false;
  });
  _updatePostsBasedOnFogLevel();
},
```

#### 진행 상태
- [x] onSelected 콜백 수정
- [ ] 필터 동작 테스트

---

### D. 쿠폰 필터 버튼 수정

#### 문제 원인
- FilterChip의 onSelected가 `_updateMarkers()`만 호출
- `_updateMarkers()`는 클러스터링만 다시 하고 서버에서 데이터를 다시 가져오지 않음
- 필터 상태만 변경되고 실제 필터링이 안 됨

#### 해결 방법
- `_updateMarkers()` 대신 `_updatePostsBasedOnFogLevel()` 호출
- 서버에서 필터가 적용된 데이터를 다시 가져옴

#### 필터링 기준 (데이터베이스 쿼리)
```dart
// lib/features/map_system/services/markers/marker_service.dart:223-226
if (filters['showCouponsOnly'] == true) {
  query = query.where('isCoupon', isEqualTo: true);
  print('서버사이드 필터: 쿠폰만 조회');
}
```

- 컬렉션: `markers`
- 필드: `isCoupon`
- 조건: true

#### 수정 위치
- `lib/features/map_system/screens/map_screen.dart:2756`

#### 수정 내용
```dart
// Before
onSelected: (selected) {
  setState(() {
    _showCouponsOnly = selected;
    if (selected) _showMyPostsOnly = false;
  });
  _updateMarkers();
},

// After
onSelected: (selected) {
  setState(() {
    _showCouponsOnly = selected;
    if (selected) _showMyPostsOnly = false;
  });
  _updatePostsBasedOnFogLevel();
},
```

#### 진행 상태
- [x] onSelected 콜백 수정
- [ ] 필터 동작 테스트

---

## 14. 클러스터링 개선

### 변경 내용
줌 레벨에 따른 클러스터링 임계값 세분화 및 최대 줌에서 클러스터링 완전히 풀기

### 변경 전
```dart
double clusterThresholdPx(double zoom) {
  if (zoom < 10) return 84;
  if (zoom < 13) return 64;
  if (zoom < 16) return 44;
  return 30;  // 줌 16 이상에서도 30px 클러스터링
}
```

### 변경 후
```dart
double clusterThresholdPx(double zoom) {
  if (zoom < 10) return 84;  // 매우 넓은 범위 (줌 아웃)
  if (zoom < 13) return 64;  // 넓은 범위
  if (zoom < 16) return 44;  // 중간 범위
  if (zoom < 17) return 30;  // 좁은 범위
  return 0;                  // 줌 17 이상: 클러스터링 완전히 풀림
}
```

### 추가 개선
- `buildProximityClusters` 함수에 thresholdPx <= 0 체크 추가
- 임계값이 0이면 모든 마커를 개별로 반환하여 클러스터링 완전히 비활성화

### 수정 파일
- `lib/features/map_system/utils/client_cluster.dart:32-39`
- `lib/features/map_system/utils/client_cluster.dart:44-47`

### 클러스터링 단계별 동작
| 줌 레벨 | 임계값(px) | 동작 |
|---------|-----------|------|
| < 10    | 84px      | 매우 강한 클러스터링 |
| 10-12   | 64px      | 강한 클러스터링 |
| 13-15   | 44px      | 중간 클러스터링 |
| 16      | 30px      | 약한 클러스터링 |
| 17      | 0px       | 클러스터링 없음 (모든 마커 표시) |

### 진행 상태
- [x] clusterThresholdPx 함수 수정
- [x] buildProximityClusters 안전 가드 추가
- [x] 줌 17에서 모든 마커 개별 표시 확인

---

## 전체 진행 상태

- [x] 업데이트 문서 작성
- [x] 맵 기능 개선 (4개 항목)
- [x] 맵 줌 레벨 확장 (17까지)
- [x] Mock 위치 줌 유지
- [x] 클러스터링 개선 (줌 17에서 풀림)
- [x] 배포 통계 대시보드 (데이터 연결 최적화 완료)
- [x] 포스트별 통계 페이지 (배포 위치 지도, 추가 KPI, 차트 완료)
- [x] 지갑 기능 개선 (콤마, 일/월/요일별 그래프, 히스토그램 완료)
- [x] 검색 기능 개선 (홈 아이콘 추가)
- [x] 내 플레이스 개선 (완료)
- [x] 성능 최적화
- [x] 쿠폰 옵션 기능 (이미 구현 완료 확인)

---

## 테스트 체크리스트

### 맵 기능
- [ ] 줌인 레벨 17까지 가능한지 확인
- [ ] Mock 위치 상하좌우 이동이 25m씩 되는지 확인
- [ ] 내 포스트 버튼 클릭 시 내가 배포한 포스트만 표시되는지 확인
- [ ] 쿠폰 버튼 클릭 시 쿠폰 포스트만 표시되는지 확인
- [ ] 필터 해제 시 모든 포스트가 다시 표시되는지 확인

### 지갑
- [ ] 포인트 탭 정상 작동
- [ ] 포인트 통계 탭 정상 표시
- [ ] 이미지/회수한전단지 탭 제거 확인

### 검색
- [ ] 예산 관련 기능 제거 확인
- [ ] 홈 아이콘 클릭 시 내 플레이스로 이동

### 내 플레이스
- [ ] 상단 지도 표시
- [ ] 플레이스 마커 표시
- [ ] 카테고리 아이콘 표시
- [ ] 주소 검증 작동
- [ ] 쿠폰 옵션 설정 작동

### 성능
- [ ] 메인 스크린 포인트 로드 빈도 감소 확인
- [ ] 디버그 로그 감소 확인

---

## 참고사항

### 데이터베이스 쿼리 기준
- **내 포스트 필터**: `markers` 컬렉션의 `creatorId` 필드
- **쿠폰 필터**: `markers` 컬렉션의 `isCoupon` 필드
- **거리 필터**: 사용자 위치 기준 반경 내 필터링 (일반: 1-3km, 슈퍼: 5km)

### Mock 위치 이동 거리 계산
- 위도/경도 1도 ≈ 111km
- 25m = 0.000225도
- 100m = 0.0009도

---

## 완료 일자
- 시작: 2025-10-03
- 완료: (진행 중)
