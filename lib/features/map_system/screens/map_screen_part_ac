            Container(
              padding: EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.orange[50],
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: Colors.orange[200]!, width: 2),
              ),
              child: Row(
                children: [
                  Icon(Icons.touch_app, size: 24, color: Colors.orange[700]),
                  SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      'ì´ ì˜ì—­ì„ í„°ì¹˜í•˜ë©´\ní¬ì¸íŠ¸ë¥¼ ë°›ê³  í™•ì¸ë©ë‹ˆë‹¤',
                      style: TextStyle(
                        fontSize: 14,
                        color: Colors.orange[700],
                        fontWeight: FontWeight.w600,
                        height: 1.3,
                      ),
                    ),
                  ),
                  Icon(Icons.arrow_upward, size: 28, color: Colors.orange[700]),
                ],
              ),
            ),
          ] else ...[
            SizedBox(height: 16),
            Container(
              padding: EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.green[50],
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: Colors.green[200]!, width: 2),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.check_circle, size: 24, color: Colors.green[700]),
                  SizedBox(width: 12),
                  Text(
                    'í™•ì¸ ì™„ë£Œ!',
                    style: TextStyle(
                      fontSize: 16,
                      color: Colors.green[700],
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ],
      ),
    );
  }

    void _showFilterDialog() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        height: MediaQuery.of(context).size.height * 0.6,
        decoration: const BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.only(
            topLeft: Radius.circular(20),
            topRight: Radius.circular(20),
          ),
        ),
        child: Column(
            children: [
            // í•¸ë“¤ ë°”
            Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.symmetric(vertical: 12),
              decoration: BoxDecoration(
                color: Colors.grey[300],
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            // ì œëª©
            const Padding(
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 10),
              child: Text(
                'í•„í„° ì„¤ì •',
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
            // í•„í„° ë‚´ìš©
            Expanded(
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: Column(
            children: [
                    const SizedBox(height: 20),
                    // ì¼ë°˜/ì¿ í° í† ê¸€
                    Row(
                      children: [
                        const Text('í¬ìŠ¤íŠ¸ íƒ€ì…:', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w500)),
                        const SizedBox(width: 20),
                        Expanded(
                          child: Row(
                            children: [
                              Expanded(
          child: GestureDetector(
                                  onTap: () => setState(() => _selectedCategory = 'all'),
            child: Container(
                                    padding: const EdgeInsets.symmetric(vertical: 12),
              decoration: BoxDecoration(
                                      color: _selectedCategory == 'all' ? Colors.blue : Colors.grey[200],
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                    child: const Text(
                                      'ì „ì²´',
                                      textAlign: TextAlign.center,
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontWeight: FontWeight.w500,
                                      ),
                                    ),
                                  ),
                                ),
                              ),
                              const SizedBox(width: 8),
                              Expanded(
                                child: GestureDetector(
                                  onTap: () => setState(() => _selectedCategory = 'coupon'),
                                  child: Container(
                                    padding: const EdgeInsets.symmetric(vertical: 12),
                decoration: BoxDecoration(
                                      color: _selectedCategory == 'coupon' ? Colors.blue : Colors.grey[200],
                  borderRadius: BorderRadius.circular(8),
                ),
                                    child: const Text(
                                      'ì¿ í°ë§Œ',
                  textAlign: TextAlign.center,
                                      style: TextStyle(
                color: Colors.white,
                                        fontWeight: FontWeight.w500,
              ),
            ),
          ),
                ),
              ),
            ],
          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 30),
                    // ê±°ë¦¬ í‘œì‹œ (ìœ ë£Œ/ë¬´ë£Œì— ë”°ë¼)
                    Row(
                      children: [
                        const Text('ê²€ìƒ‰ ë°˜ê²½:', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w500)),
                        const SizedBox(width: 20),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                          decoration: BoxDecoration(
                            color: _isPremiumUser ? Colors.amber[50] : Colors.blue[50],
                            borderRadius: BorderRadius.circular(8),
                            border: Border.all(color: _isPremiumUser ? Colors.amber[200]! : Colors.blue[200]!),
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Text(
                                '${_maxDistance.toInt()}m',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.bold,
                                  color: _isPremiumUser ? Colors.amber[800] : Colors.blue,
                                ),
                              ),
                              if (_isPremiumUser) ...[
                                const SizedBox(width: 8),
                                Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                  decoration: BoxDecoration(
                                    color: Colors.amber[600],
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: const Text(
                                    'PRO',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 10,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                              ],
                            ],
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 30),
                    // ë¦¬ì›Œë“œ ìŠ¬ë¼ì´ë”
                    Row(
                      children: [
                        const Text('ìµœì†Œ ë¦¬ì›Œë“œ:', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w500)),
                        const SizedBox(width: 20),
                        Expanded(
                          child: Column(
                            children: [
                              Text('${_minReward}ì›', 
                                style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                              Slider(
                                value: _minReward.toDouble(),
                                min: 0,
                                max: 10000,
                                divisions: 100,
                                onChanged: (value) {
    setState(() {
                                    _minReward = value.toInt();
                                  });
                                },
            ),
          ],
        ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 30),
                    // ì •ë ¬ ì˜µì…˜
                    Row(
          children: [
                        const Text('ì •ë ¬:', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w500)),
                        const SizedBox(width: 20),
                        Expanded(
                          child: Row(
                            children: [
                              Expanded(
                                child: GestureDetector(
                                  onTap: () => setState(() {}),
                                  child: Container(
                                    padding: const EdgeInsets.symmetric(vertical: 12),
                                    decoration: BoxDecoration(
                                      color: Colors.blue,
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                    child: const Text(
                                      'ê°€ê¹Œìš´ìˆœ',
                                      textAlign: TextAlign.center,
              style: TextStyle(
                                        color: Colors.white,
                                        fontWeight: FontWeight.w500,
                                      ),
                                    ),
                                  ),
                                ),
                              ),
                              const SizedBox(width: 8),
                              Expanded(
                                child: GestureDetector(
                                  onTap: () => setState(() {}),
                                  child: Container(
                  padding: const EdgeInsets.symmetric(vertical: 12),
                decoration: BoxDecoration(
                                      color: Colors.grey[200],
                    borderRadius: BorderRadius.circular(8),
                  ),
                                    child: const Text(
                                      'ìµœì‹ ìˆœ',
                  textAlign: TextAlign.center,
                                      style: TextStyle(
                                        color: Colors.black,
                                        fontWeight: FontWeight.w500,
                ),
              ),
            ),
                ),
              ),
            ],
          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
            // í•˜ë‹¨ ë²„íŠ¼ë“¤
            Padding(
              padding: const EdgeInsets.all(20),
              child: Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                onPressed: () {
                        Navigator.pop(context);
                        _resetFilters();
                      },
                      style: OutlinedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: const Text('ì´ˆê¸°í™”'),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: ElevatedButton(
                onPressed: () {
                        Navigator.pop(context);
                        _updateMarkers();
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.blue,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: const Text('ì ìš©'),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }



  void _resetFilters() {
    setState(() {
      _selectedCategory = 'all';
      _maxDistance = _isPremiumUser ? 3000.0 : 1000.0; // ìœ ë£Œ: 3km, ë¬´ë£Œ: 1km
      _minReward = 0;
      _showCouponsOnly = false;
      _showMyPostsOnly = false;
      _showUrgentOnly = false;
      _showVerifiedOnly = false; // ì¸ì¦ í•„í„° ì´ˆê¸°í™”
      _showUnverifiedOnly = false; // ë¯¸ì¸ì¦ í•„í„° ì´ˆê¸°í™”
    });
    _updateMarkers();
  }

  // í•„í„° ì¹© ë¹Œë” í—¬í¼ í•¨ìˆ˜
  Widget _buildFilterChip({
    required String label,
    required bool selected,
    required Function(bool) onSelected,
    required Color selectedColor,
    IconData? icon,
  }) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        boxShadow: selected ? [
          BoxShadow(
            color: selectedColor.withOpacity(0.3),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ] : null,
      ),
      child: FilterChip(
        label: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            if (icon != null) ...[
              Icon(
                icon,
                size: 14,
                color: selected ? Colors.white : selectedColor,
              ),
              const SizedBox(width: 4),
            ],
            Text(
              label,
              style: TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w500,
                color: selected ? Colors.white : selectedColor,
              ),
            ),
          ],
        ),
        selected: selected,
        onSelected: onSelected,
        selectedColor: selectedColor,
        checkmarkColor: Colors.white,
        backgroundColor: Colors.white,
        side: BorderSide(
          color: selected ? selectedColor : Colors.grey.shade300,
          width: selected ? 2 : 1,
        ),
        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
        labelPadding: const EdgeInsets.symmetric(horizontal: 4),
      ),
    );
  }

  Future<void> _navigateToPostPlace() async {
    if (_longPressedLatLng == null) return;

    // í˜„ì¬ìœ„ì¹˜, ì§‘, ì¼í„° ì£¼ë³€ì—ì„œ ë°°í¬ ê°€ëŠ¥í•œì§€ í™•ì¸
    final canDeploy = _canLongPressAtLocation(_longPressedLatLng!);

    if (!canDeploy) {
      // ê±°ë¦¬ ì´ˆê³¼ ì‹œ ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
      return;
    }

    // PostDeploymentControllerë¥¼ ì‚¬ìš©í•œ ìœ„ì¹˜ ê¸°ë°˜ í¬ìŠ¤íŠ¸ ë°°í¬
    final success = await PostDeploymentController.deployPostFromLocation(context, _longPressedLatLng!);

    // í¬ìŠ¤íŠ¸ ë°°í¬ ì™„ë£Œ í›„ ì²˜ë¦¬
    if (success) {
      print('í¬ìŠ¤íŠ¸ ë°°í¬ ì™„ë£Œ');
      // ğŸš€ ë°°í¬ ì™„ë£Œ í›„ ì¦‰ì‹œ ë§ˆì»¤ ìƒˆë¡œê³ ì¹¨
      setState(() {
        _isLoading = true;
        _longPressedLatLng = null; // íŒì—…ìš© ë³€ìˆ˜ë§Œ ì´ˆê¸°í™”
      });
      
      // ë§ˆì»¤ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
      await _updatePostsBasedOnFogLevel();
      
      // ë°ì´í„°ë² ì´ìŠ¤ ë°˜ì˜ì„ ìœ„í•´ ì¶©ë¶„í•œ ì‹œê°„ ëŒ€ê¸° í›„ ë‹¤ì‹œ í•œ ë²ˆ ì—…ë°ì´íŠ¸
      await Future.delayed(const Duration(milliseconds: 1500));
      await _updatePostsBasedOnFogLevel();
      
      // ë§ˆì§€ë§‰ìœ¼ë¡œ í•œ ë²ˆ ë” ì—…ë°ì´íŠ¸ (í™•ì‹¤í•˜ê²Œ)
      await Future.delayed(const Duration(milliseconds: 1000));
      await _updatePostsBasedOnFogLevel();
      
      setState(() {
        _isLoading = false;
      });
    } else {
      // ë°°í¬ë¥¼ ì·¨ì†Œí•œ ê²½ìš° ë¡±í”„ë ˆìŠ¤ ìœ„ì¹˜ ì´ˆê¸°í™”
      setState(() {
        _longPressedLatLng = null;
      });
    }
  }

  Future<void> _navigateToPostAddress() async {
    if (_longPressedLatLng == null) return;

    try {
      // 1. OSMì—ì„œ ê±´ë¬¼ëª… ì¡°íšŒ
      print('ğŸŒ OSMì—ì„œ ê±´ë¬¼ëª… ì¡°íšŒ ì¤‘...');
      final buildingName = await OSMGeocodingService.getBuildingName(_longPressedLatLng!);
      
      if (buildingName == null) {
        _showToast('ê±´ë¬¼ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      print('âœ… ê±´ë¬¼ëª… ì¡°íšŒ ì„±ê³µ: $buildingName');
      
      // 2. ê±´ë¬¼ëª… í™•ì¸ íŒì—…
      final isCorrect = await _showBuildingNameConfirmation(buildingName);
      
      if (isCorrect) {
        // 3. í¬ìŠ¤íŠ¸ ë°°í¬ í™”ë©´ìœ¼ë¡œ ì´ë™ (ì£¼ì†Œ ëª¨ë“œ)
        _navigateToPostDeploy('address', buildingName);
    } else {
        // 4. ì£¼ì†Œ ê²€ìƒ‰ íŒì—…
        final selectedAddress = await _showAddressSearchDialog();
        if (selectedAddress != null) {
          _navigateToPostDeploy('address', selectedAddress['display_name']);
        }
      }
    } catch (e) {
      print('âŒ ì£¼ì†Œ ë°°í¬ ì˜¤ë¥˜: $e');
      _showToast('ì£¼ì†Œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  /// ê±´ë¬¼ëª… í™•ì¸ íŒì—…
  Future<bool> _showBuildingNameConfirmation(String buildingName) async {
    return await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ìœ„ì¹˜ í™•ì¸'),
        content: Text('$buildingNameì´ ë§ìŠµë‹ˆê¹Œ?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('ì•„ë‹ˆì˜¤'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: const Text('ì˜ˆ'),
          ),
        ],
      ),
    ) ?? false;
  }

  /// ì£¼ì†Œ ê²€ìƒ‰ íŒì—…
  Future<Map<String, dynamic>?> _showAddressSearchDialog() async {
    return await showDialog<Map<String, dynamic>>(
      context: context,
      builder: (context) => const AddressSearchDialog(),
    );
  }

  /// í¬ìŠ¤íŠ¸ ë°°í¬ í™”ë©´ìœ¼ë¡œ ë„¤ë¹„ê²Œì´ì…˜
  Future<void> _navigateToPostDeploy(String type, String buildingName) async {
    final result = await Navigator.pushNamed(
      context,
      '/post-deploy',
      arguments: {
        'location': _longPressedLatLng!,
        'type': type,
        'buildingName': buildingName,
      },
    );

    if (result != null && mounted) {
      // ë°°í¬ ì™„ë£Œ í›„ ë§ˆì»¤ ìƒˆë¡œê³ ì¹¨
      setState(() {
        _isLoading = true;
        _longPressedLatLng = null;
      });
      
      print('ğŸš€ ë°°í¬ ì™„ë£Œ - ì¦‰ì‹œ ë§ˆì»¤ ì¡°íšŒ ì‹œì‘');
      
      // âœ… í•´ê²°ì±… 2: í¬ê·¸/íƒ€ì¼/ìºì‹œ íŒŒìƒê°’ ì¬ë¹Œë“œ
      if (_currentPosition != null) {
        final currentTileId = TileUtils.getKm1TileId(
          _currentPosition!.latitude, 
          _currentPosition!.longitude
        );
        _rebuildFogWithUserLocations(_currentPosition!);
        _setLevel1TileLocally(currentTileId);
        print('âœ… í¬ê·¸/íƒ€ì¼ ìƒíƒœ ì¬ë¹Œë“œ ì™„ë£Œ');
      }
      
      // âœ… í•´ê²°ì±… 3: 1ë‹¨ê³„ íƒ€ì¼ ìºì‹œ ì´ˆê¸°í™” (ìƒˆ ë§ˆì»¤ ì¿¼ë¦¬ ë³´ì¥)
      _clearFogLevel1Cache();
      print('âœ… 1ë‹¨ê³„ íƒ€ì¼ ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ');
      
      // âœ… í•´ê²°ì±… 4: ê°•ì œ fetch
      await _updatePostsBasedOnFogLevel();
      print('âœ… ë§ˆì»¤ ì¡°íšŒ ì™„ë£Œ');
      
      setState(() {
        _isLoading = false;
      });
    } else {
      // ì·¨ì†Œí•œ ê²½ìš°
      setState(() {
        _longPressedLatLng = null;
      });
    }
  }

  /// í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
  void _showToast(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.orange,
      ),
    );
  }

  Future<void> _navigateToPostBusiness() async {
    if (_longPressedLatLng == null) return;

    // PostDeploymentControllerë¥¼ ì‚¬ìš©í•œ ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ í¬ìŠ¤íŠ¸ ë°°í¬
    final success = await PostDeploymentController.deployPostFromCategory(context, _longPressedLatLng!);

    // í¬ìŠ¤íŠ¸ ë°°í¬ ì™„ë£Œ í›„ ì²˜ë¦¬
    if (success) {
      print('í¬ìŠ¤íŠ¸ ë°°í¬ ì™„ë£Œ');
      // ğŸš€ ë°°í¬ ì™„ë£Œ í›„ ì¦‰ì‹œ ë§ˆì»¤ ìƒˆë¡œê³ ì¹¨
      setState(() {
        _isLoading = true;
        _longPressedLatLng = null; // íŒì—…ìš© ë³€ìˆ˜ë§Œ ì´ˆê¸°í™”
      });
      
      // ë§ˆì»¤ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
      await _updatePostsBasedOnFogLevel();
      
      // ë°ì´í„°ë² ì´ìŠ¤ ë°˜ì˜ì„ ìœ„í•´ ì¶©ë¶„í•œ ì‹œê°„ ëŒ€ê¸° í›„ ë‹¤ì‹œ í•œ ë²ˆ ì—…ë°ì´íŠ¸
      await Future.delayed(const Duration(milliseconds: 1500));
      await _updatePostsBasedOnFogLevel();
      
      // ë§ˆì§€ë§‰ìœ¼ë¡œ í•œ ë²ˆ ë” ì—…ë°ì´íŠ¸ (í™•ì‹¤í•˜ê²Œ)
      await Future.delayed(const Duration(milliseconds: 1000));
      await _updatePostsBasedOnFogLevel();
      
      setState(() {
        _isLoading = false;
      });
    } else {
      // ë°°í¬ë¥¼ ì·¨ì†Œí•œ ê²½ìš° ë¡±í”„ë ˆìŠ¤ ìœ„ì¹˜ ì´ˆê¸°í™”
      setState(() {
        _longPressedLatLng = null;
      });
    }
  }

  void _showLongPressMenu() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        height: MediaQuery.of(context).size.height * 0.4,
        decoration: const BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.only(
            topLeft: Radius.circular(20),
            topRight: Radius.circular(20),
          ),
        ),
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // í•¸ë“¤ ë°”
              Center(
                child: Container(
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: Colors.grey[300],
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
              ),
              const SizedBox(height: 20),
              
              // ì œëª©
              const Text(
                'í¬ìŠ¤íŠ¸ ë°°í¬',
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 8),
              
              // ì„¤ëª…
              const Text(
                'ì´ ìœ„ì¹˜ì— í¬ìŠ¤íŠ¸ë¥¼ ë°°í¬í•˜ì„¸ìš”',
                style: TextStyle(
                  fontSize: 14,
                  color: Colors.grey,
                ),
              ),
              const SizedBox(height: 24),
              
              // ë©”ë‰´ ì˜µì…˜ë“¤
              Expanded(
                child: Column(
                  children: [
                    // ì´ ìœ„ì¹˜ì— ë¿Œë¦¬ê¸°
                    SizedBox(
                      width: double.infinity,
                      height: 60,
                      child: ElevatedButton.icon(
                        onPressed: () {
                          Navigator.pop(context);
                          _navigateToPostPlace();
                        },
                        icon: const Icon(Icons.location_on, color: Colors.white),
                        label: const Text(
                          'ì´ ìœ„ì¹˜ì— ë¿Œë¦¬ê¸°',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: Colors.white,
                          ),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF4D4DFF),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 12),
                    
                    // ì´ ì£¼ì†Œì— ë¿Œë¦¬ê¸°
                    SizedBox(
                      width: double.infinity,
                      height: 60,
                      child: ElevatedButton.icon(
                        onPressed: () {
                          Navigator.pop(context);
                          _navigateToPostAddress();
                        },
                        icon: const Icon(Icons.home, color: Colors.white),
                        label: const Text(
                          'ì´ ì£¼ì†Œì— ë¿Œë¦¬ê¸°',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: Colors.white,
                          ),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.green,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 12),
                    
                    // ê·¼ì²˜ ì—…ì¢…ì— ë¿Œë¦¬ê¸° (ì‘ì—…ì¤‘)
                    SizedBox(
                      width: double.infinity,
                      height: 60,
                      child: ElevatedButton.icon(
                        onPressed: null, // ë¹„í™œì„±í™”
                        icon: const Icon(Icons.business, color: Colors.white),
                        label: const Text(
                          'ê·¼ì²˜ ì—…ì¢…ì— ë¿Œë¦¬ê¸° (ì‘ì—…ì¤‘)',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: Colors.white,
                          ),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.grey, // íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              
            ],
          ),
        ),
      ),
    );
  }



  void _onMapReady() {
    // í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
    if (_currentPosition != null) {
      _mapController?.move(_currentPosition!, _currentZoom);
    }
  }

  // ì§‘ìœ¼ë¡œ ì´ë™
  void _moveToHome() {
    if (_homeLocation != null) {
      _mapController?.move(_homeLocation!, _currentZoom);
    }
  }

  // ì¼í„°ë¡œ ì´ë™ (ìˆœì°¨ì ìœ¼ë¡œ)
  void _moveToWorkplace() {
    if (_workLocations.isNotEmpty) {
      final targetLocation = _workLocations[_currentWorkplaceIndex];
      _mapController?.move(targetLocation, _currentZoom);
      
      // ë‹¤ìŒ ì¼í„°ë¡œ ì¸ë±ìŠ¤ ì´ë™ (ìˆœí™˜)
      setState(() {
        _currentWorkplaceIndex = (_currentWorkplaceIndex + 1) % _workLocations.length;
      });
    }
  }

  double _calculateDistance(LatLng point1, LatLng point2) {
    const double earthRadius = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
    
    final double dLat = _degreesToRadians(point2.latitude - point1.latitude);
    final double dLon = _degreesToRadians(point2.longitude - point1.longitude);
    
    final double a = sin(dLat / 2) * sin(dLat / 2) +
        sin(_degreesToRadians(point1.latitude)) * sin(_degreesToRadians(point2.latitude)) * 
        sin(dLon / 2) * sin(dLon / 2);
    final double c = 2 * asin(sqrt(a));
    
    return earthRadius * c;
  }

  double _degreesToRadians(double degrees) {
    return degrees * (pi / 180);
  }

  // Mock ìœ„ì¹˜ ê´€ë ¨ ë©”ì„œë“œë“¤
  void _toggleMockMode() {
    setState(() {
      _isMockModeEnabled = !_isMockModeEnabled;
      if (_isMockModeEnabled) {
        _isMockControllerVisible = true;
        // ì›ë˜ GPS ìœ„ì¹˜ ë°±ì—…
        _originalGpsPosition = _currentPosition;
        // Mock ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ í˜„ì¬ GPS ìœ„ì¹˜ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        if (_mockPosition == null && _currentPosition != null) {
          _mockPosition = _currentPosition;
        }
      } else {
        _isMockControllerVisible = false;
        // Mock ëª¨ë“œ ë¹„í™œì„±í™” ì‹œ ì›ë˜ GPS ìœ„ì¹˜ë¡œ ë³µì›
        if (_originalGpsPosition != null) {
          _currentPosition = _originalGpsPosition;
          _mapController?.move(_originalGpsPosition!, _currentZoom);
          _createCurrentLocationMarker(_originalGpsPosition!);
          _updateCurrentAddress();
          _updatePostsBasedOnFogLevel();
        }
      }
    });
  }

  Future<void> _setMockPosition(LatLng position) async {
    // ì´ì „ Mock ìœ„ì¹˜ ì €ì¥ (íšŒìƒ‰ ì˜ì—­ í‘œì‹œìš©)
    final previousPosition = _mockPosition;
    
    setState(() {
      _mockPosition = position;
      // Mock ëª¨ë“œì—ì„œëŠ” ì‹¤ì œ ìœ„ì¹˜ë„ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ê¸°ëŠ¥ì²˜ëŸ¼ ë™ì‘)
      if (_isMockModeEnabled) {
        _currentPosition = position;
      }
    });

    // Mock ìœ„ì¹˜ë¡œ ì§€ë„ ì¤‘ì‹¬ ì´ë™ (í˜„ì¬ ì¤Œ ë ˆë²¨ ìœ ì§€)
    final currentZoom = _mapController?.camera.zoom ?? _currentZoom;
    _mapController?.move(position, currentZoom);
    
    // Mock ìœ„ì¹˜ ë§ˆì»¤ ìƒì„±
    _createCurrentLocationMarker(position);
    
    // ì£¼ì†Œ ì—…ë°ì´íŠ¸ (Mock ìœ„ì¹˜ ê¸°ì¤€)
    _updateMockAddress(position);
    
    // íƒ€ì¼ ë°©ë¬¸ ê¸°ë¡ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ê¸°ëŠ¥ì²˜ëŸ¼ ë™ì‘)
    final tileId = TileUtils.getKm1TileId(position.latitude, position.longitude);
    print('ğŸ­ Mock ìœ„ì¹˜ íƒ€ì¼ ë°©ë¬¸ ê¸°ë¡ ì—…ë°ì´íŠ¸: $tileId');
    await VisitTileService.updateCurrentTileVisit(tileId);
    _setLevel1TileLocally(tileId);
    
    // í¬ê·¸ ì˜¤ë¸Œ ì›Œ ì¬êµ¬ì„± (ì‹¤ì œ ê¸°ëŠ¥ì²˜ëŸ¼ ë™ì‘)
    _rebuildFogWithUserLocations(position);
    
    // íšŒìƒ‰ ì˜ì—­ ì—…ë°ì´íŠ¸ (ì´ì „ ìœ„ì¹˜ í¬í•¨)
    _updateGrayAreasWithPreviousPosition(previousPosition);
    
    // ë§ˆì»¤ ì—…ë°ì´íŠ¸
    _updatePostsBasedOnFogLevel();
  }

  Future<void> _updateMockAddress(LatLng position) async {
    try {
      final address = await NominatimService.reverseGeocode(position);
      setState(() {
        _currentAddress = address;
      });
      widget.onAddressChanged?.call(address);
    } catch (e) {
      setState(() {
        _currentAddress = 'ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨';
      });
    }
  }

  // í™”ì‚´í‘œ ë°©í–¥ì— ë”°ë¥¸ Mock ìœ„ì¹˜ ì´ë™
  void _moveMockPosition(String direction) async {
    if (_mockPosition == null) return;

    const double moveDistance = 0.000225; // ì•½ 25m ì´ë™
    LatLng newPosition;
    
    switch (direction) {
      case 'up':
        newPosition = LatLng(_mockPosition!.latitude + moveDistance, _mockPosition!.longitude);
        break;
      case 'down':
        newPosition = LatLng(_mockPosition!.latitude - moveDistance, _mockPosition!.longitude);
        break;
      case 'left':
        newPosition = LatLng(_mockPosition!.latitude, _mockPosition!.longitude - moveDistance);
        break;
      case 'right':
        newPosition = LatLng(_mockPosition!.latitude, _mockPosition!.longitude + moveDistance);
        break;
      default:
        return;
    }
    
    await _setMockPosition(newPosition);
  }

  void _hideMockController() {
    setState(() {
      _isMockControllerVisible = false;
    });
  }

  Future<void> _showMockPositionInputDialog() async {
    final latController = TextEditingController(
      text: _mockPosition?.latitude.toStringAsFixed(6) ?? '',
    );
    final lngController = TextEditingController(
      text: _mockPosition?.longitude.toStringAsFixed(6) ?? '',
    );

    final result = await showDialog<bool>(
      context: context,
      builder: (dialogContext) => AlertDialog(
        title: const Text('Mock ìœ„ì¹˜ ì§ì ‘ ì…ë ¥'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: latController,
              keyboardType: const TextInputType.numberWithOptions(decimal: true, signed: true),
              decoration: const InputDecoration(
                labelText: 'ìœ„ë„ (Latitude)',
                hintText: '37.5665',
                border: OutlineInputBorder(),
              ),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: lngController,
              keyboardType: const TextInputType.numberWithOptions(decimal: true, signed: true),
              decoration: const InputDecoration(
                labelText: 'ê²½ë„ (Longitude)',
                hintText: '126.9780',
                border: OutlineInputBorder(),
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'ì˜ˆì‹œ: ì„œìš¸ì‹œì²­ (37.5665, 126.9780)',
              style: TextStyle(fontSize: 11, color: Colors.grey[600]),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(dialogContext, false),
            child: const Text('ì·¨ì†Œ'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(dialogContext, true);
            },
            style: ElevatedButton.styleFrom(backgroundColor: Colors.purple),
            child: const Text('ì´ë™'),
          ),
        ],
      ),
    );

    if (result == true) {
      try {
        final lat = double.parse(latController.text);
        final lng = double.parse(lngController.text);
        
        // ìœ íš¨ ë²”ìœ„ ì²´í¬ (ëŒ€ëµì ì¸ í•œêµ­ ë²”ìœ„)
        if (lat < 33.0 || lat > 39.0 || lng < 124.0 || lng > 132.0) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('í•œêµ­ ë²”ìœ„ ë‚´ì˜ ì¢Œí‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”')),
          );
          return;
        }

        final newPosition = LatLng(lat, lng);
        await _setMockPosition(newPosition);
        
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Mock ìœ„ì¹˜ ì´ë™: ${lat.toStringAsFixed(4)}, ${lng.toStringAsFixed(4)}')),
        );
      } catch (e) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”')),
        );
      }
    }

    latController.dispose();
    lngController.dispose();
  }

  // í†µí•©ëœ íšŒìƒ‰ ì˜ì—­ ì—…ë°ì´íŠ¸ (DBì—ì„œ ìµœì‹  ë°©ë¬¸ ê¸°ë¡ ë¡œë“œ)
  void _updateGrayAreasWithPreviousPosition(LatLng? previousPosition) async {
    try {
      // DBì—ì„œ ìµœì‹  ë°©ë¬¸ ê¸°ë¡ ë¡œë“œ (ì„œë²„ ê°•ì œ ì½ê¸°)
      final visitedPositions = await _loadVisitedPositionsFromDB();
      
      // ì´ì „ ìœ„ì¹˜ë„ ì¶”ê°€ (ì¦‰ì‹œ ë°˜ì˜ìš©)
      if (previousPosition != null) {
        visitedPositions.add(previousPosition);
        print('ğŸ¯ ì´ì „ ìœ„ì¹˜ë¥¼ íšŒìƒ‰ ì˜ì—­ìœ¼ë¡œ ì¶”ê°€: ${previousPosition.latitude}, ${previousPosition.longitude}');
      }
      
      // ìƒˆë¡œìš´ íšŒìƒ‰ ì˜ì—­ ìƒì„±
      final grayPolygons = OSMFogService.createGrayAreas(visitedPositions);
      
      setState(() {
        _grayPolygons = grayPolygons;
      });
      
      print('âœ… íšŒìƒ‰ ì˜ì—­ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${visitedPositions.length}ê°œ ìœ„ì¹˜');
    } catch (e) {
      print('âŒ íšŒìƒ‰ ì˜ì—­ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: $e');
    }
  }

  // DBì—ì„œ ìµœì‹  ë°©ë¬¸ ê¸°ë¡ ë¡œë“œ (ì„œë²„ ê°•ì œ ì½ê¸°)
  Future<List<LatLng>> _loadVisitedPositionsFromDB() async {
    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) return [];

      // 30ì¼ ì´ë‚´ ë°©ë¬¸ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° (ì„œë²„ ê°•ì œ ì½ê¸°)
      final thirtyDaysAgo = DateTime.now().subtract(const Duration(days: 30));
      
      final visitedTiles = await FirebaseFirestore.instance
          .collection('users')
          .doc(user.uid)
          .collection('visited_tiles')
          .where('lastVisitTime', isGreaterThanOrEqualTo: Timestamp.fromDate(thirtyDaysAgo))
          .get(const GetOptions(source: Source.server)); // ì„œë²„ ê°•ì œ ì½ê¸°

      final visitedPositions = <LatLng>[];
      
      for (final doc in visitedTiles.docs) {
        final tileId = doc.id;
        // íƒ€ì¼ IDì—ì„œ ì¢Œí‘œ ì¶”ì¶œ
        final position = _extractPositionFromTileId(tileId);
        if (position != null) {
          visitedPositions.add(position);
        }
      }

      print('ğŸ” DBì—ì„œ ë¡œë“œëœ ë°©ë¬¸ ìœ„ì¹˜ ê°œìˆ˜: ${visitedPositions.length}');
      return visitedPositions;
    } catch (e) {
      print('âŒ DBì—ì„œ ë°©ë¬¸ ìœ„ì¹˜ ë¡œë“œ ì‹¤íŒ¨: $e');
      return [];
    }
  }

  @override
  void dispose() {
    _workplaceSubscription?.cancel(); // âœ… ì¼í„° ë¦¬ìŠ¤ë„ˆ êµ¬ë… ì·¨ì†Œ
    _mapMoveTimer?.cancel(); // íƒ€ì´ë¨¸ ì •ë¦¬
    _clusterDebounceTimer?.cancel(); // í´ëŸ¬ìŠ¤í„° ë””ë°”ìš´ìŠ¤ íƒ€ì´ë¨¸ ì •ë¦¬
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          GestureDetector(
            onSecondaryTapDown: (TapDownDetails details) {
              final RenderBox renderBox = context.findRenderObject() as RenderBox;
              final localPosition = renderBox.globalToLocal(details.globalPosition);
              final mapWidth = renderBox.size.width;
              final mapHeight = renderBox.size.height;
              final latRatio = localPosition.dy / mapHeight;
              final lngRatio = localPosition.dx / mapWidth;
              final lat = _currentPosition!.latitude + (0.01 * (0.5 - latRatio));
              final lng = _currentPosition!.longitude + (0.01 * (lngRatio - 0.5));
              setState(() {
                _longPressedLatLng = LatLng(lat, lng);
              });
            },
            child: FlutterMap(
              mapController: _mapController,
        options: MapOptions(
                initialCenter: _currentPosition ?? const LatLng(37.5665, 126.9780), // ì„œìš¸ ê¸°ë³¸ê°’
                initialZoom: _currentZoom,
                minZoom: 14.0,  // ìµœì†Œ ì¤Œ ë ˆë²¨ (ì¤Œ ì•„ì›ƒ í•œê³„)
                maxZoom: 17.0,  // ìµœëŒ€ ì¤Œ ë ˆë²¨ (ì¤Œ ì¸ í•œê³„)
          onMapReady: _onMapReady,
                onMapEvent: _onMapMoved, // ğŸš€ ì§€ë„ ì´ë™ ê°ì§€
                onTap: (tapPosition, point) {
                  setState(() {
                    _longPressedLatLng = null;
                  });
                },
                onLongPress: (tapPosition, point) async {
                  // Mock ëª¨ë“œì—ì„œëŠ” Mock ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ, ì•„ë‹ˆë©´ ì‹¤ì œ GPS ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í™•ì¸
                  LatLng? referencePosition;
                  if (_isMockModeEnabled && _mockPosition != null) {
                    referencePosition = _mockPosition;
                  } else {
                    referencePosition = _currentPosition;
                  }

                  // ê¸°ì¤€ ìœ„ì¹˜ í™•ì¸
                  if (referencePosition == null) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(content: Text('í˜„ì¬ ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')),
                    );
                    return;
                  }

                  // í˜„ì¬ìœ„ì¹˜, ì§‘, ì¼í„° ì£¼ë³€ì—ì„œ ë¡±í”„ë ˆìŠ¤ ê°€ëŠ¥í•œì§€ í™•ì¸
                  final canLongPress = _canLongPressAtLocation(point);

                  if (!canLongPress) {
                    // ê±°ë¦¬ ì´ˆê³¼ ì‹œ ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
                    return;
                  }

                  // ë¡±í”„ë ˆìŠ¤ ìœ„ì¹˜ ì €ì¥
                  _longPressedLatLng = point;
                  
                  // ë°”ë¡œ ë°°í¬ ë©”ë‰´ í‘œì‹œ (í¬ê·¸ë ˆë²¨ í™•ì¸ ìƒëµ)
                  _showLongPressMenu();
                },
              ),
        children: [
                // OSM ê¸°ë°˜ CartoDB Voyager íƒ€ì¼ (ë¼ë²¨ ì—†ìŒ)
                TileLayer(
                  urlTemplate: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png',
                  subdomains: const ['a', 'b', 'c', 'd'],
                  userAgentPackageName: 'com.ppamalpha.app',
                  minZoom: 14.0,  // íƒ€ì¼ ì„œë²„ ìµœì†Œ ì¤Œ
                  maxZoom: 17.0,  // íƒ€ì¼ ì„œë²„ ìµœëŒ€ ì¤Œ
                ),
                // í†µí•© í¬ê·¸ ì˜¤ë²„ë ˆì´ (ê²€ì • â†’ í€ì¹­ â†’ íšŒìƒ‰)
                UnifiedFogOverlayWidget(
                  mapController: _mapController!,
                  level1Centers: [
                    if (_currentPosition != null) _currentPosition!,
                    if (_homeLocation != null) _homeLocation!,
                    ..._workLocations,
                  ],
                  level2CentersRaw: _grayPolygons.isNotEmpty 
                    ? _grayPolygons.map((polygon) {
                        // í´ë¦¬ê³¤ì˜ ì¤‘ì‹¬ì  ê³„ì‚°
                        if (polygon.points.isEmpty) return const LatLng(0, 0);
                        double sumLat = 0, sumLng = 0;
                        for (final point in polygon.points) {
                          sumLat += point.latitude;
                          sumLng += point.longitude;
                        }
                        return LatLng(
                          sumLat / polygon.points.length,
                          sumLng / polygon.points.length,
                        );
                      }).toList()
                    : [],
                  radiusMeters: 1000.0,
                  fogColor: Colors.black.withOpacity(1.0),
                  grayColor: Colors.grey.withOpacity(0.33),
                ),
                // 1km ê²½ê³„ì„  (ì œê±°ë¨ - íŒŒë€ìƒ‰ ì› í…Œë‘ë¦¬ ì—†ìŒ)
                // CircleLayer(circles: _ringCircles),
                // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ë“¤
                MarkerLayer(
                  markers: [
                    // ì§‘ ìœ„ì¹˜ ë§ˆì»¤
                    if (_homeLocation != null)
                      Marker(
                        point: _homeLocation!,
             child: Container(
               decoration: BoxDecoration(
                            color: Colors.green,
                            shape: BoxShape.circle,
                            border: Border.all(color: Colors.white, width: 2),
                          ),
                          child: const Icon(
                            Icons.home,
                 color: Colors.white,
                            size: 20,
                          ),
                        ),
                      ),
                    // ì¼í„° ìœ„ì¹˜ ë§ˆì»¤ë“¤
                    ..._workLocations.map((workLocation) => Marker(
                      point: workLocation,
                      child: Container(
                        decoration: BoxDecoration(
                          color: Colors.orange,
                          shape: BoxShape.circle,
                          border: Border.all(color: Colors.white, width: 2),
                        ),
                        child: const Icon(
                          Icons.work,
                          color: Colors.white,
                          size: 20,
                        ),
                      ),
                    )),
                  ],
                ),
                // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤
                MarkerLayer(markers: _currentMarkers),
                // Firebase ë§ˆì»¤ë“¤ (í¬ìŠ¤íŠ¸ + ì‚¬ìš©ì ìƒì„± ë§ˆì»¤)
                MarkerLayer(markers: _clusteredMarkers),
                      ],
                    ),
          ),
          // ë¡œë”© ì¸ë””ì¼€ì´í„°
          if (_isLoading)
            Positioned(
              top: 50,
              left: 16,
              right: 16,
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.1),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    const SizedBox(
                      width: 20,
                      height: 20,
                      child: CircularProgressIndicator(strokeWidth: 2),
                    ),
                    const SizedBox(width: 12),
                    const Text('ë§ˆì»¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'),
                  ],
                ),
              ),
            ),
          // ì—ëŸ¬ ë©”ì‹œì§€
          if (_errorMessage != null)
           Positioned(
              top: 50,
              left: 16,
              right: 16,
             child: Container(
                padding: const EdgeInsets.all(16),
               decoration: BoxDecoration(
                  color: Colors.red,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  _errorMessage!,
                  style: const TextStyle(color: Colors.white),
                ),
              ),
            ),
          // ë¡œë”© ì¸ë””ì¼€ì´í„°
          if (_isLoading)
            const Center(
              child: CircularProgressIndicator(),
            ),
          // í•„í„° ë²„íŠ¼ë“¤ (ìƒë‹¨) - ê°œì„ ëœ ë””ìì¸
          Positioned(
            top: 10,
            left: 16,
            right: 16,
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 10,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
               child: Row(
                 children: [
                  // í•„í„° ì•„ì´ì½˜
                  Icon(Icons.tune, color: Colors.blue[600], size: 18),
                  const SizedBox(width: 8),
                  
                  // í•„í„° ë²„íŠ¼ë“¤
