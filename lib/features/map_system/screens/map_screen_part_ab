        point,
      );
      if (distanceToWork <= maxRadius) {
        return true;
      }
    }
    
    return false;
  }

  // ğŸš€ í¬ê·¸ë ˆë²¨ í™•ì¸ í›„ ë¡±í”„ë ˆìŠ¤ ë©”ë‰´ í‘œì‹œ
  Future<void> _checkFogLevelAndShowMenu(LatLng point) async {
    try {
      // í•´ë‹¹ ìœ„ì¹˜ì˜ í¬ê·¸ë ˆë²¨ í™•ì¸
      final tileId = TileUtils.getTileId(point.latitude, point.longitude);
      
      print('ğŸ” í¬ê·¸ë ˆë²¨ í™•ì¸ ì‹œì‘:');
      print('  - ë¡±í”„ë ˆìŠ¤ ìœ„ì¹˜: ${point.latitude}, ${point.longitude}');
      print('  - í˜„ì¬ ìœ„ì¹˜: ${_currentPosition?.latitude}, ${_currentPosition?.longitude}');
      print('  - íƒ€ì¼ ID: $tileId');
      
      final fogLevel = await VisitTileService.getFogLevelForTile(tileId);
      
      print('ğŸ” ë¡±í”„ë ˆìŠ¤ ìœ„ì¹˜ í¬ê·¸ë ˆë²¨: $fogLevel (íƒ€ì¼: $tileId)');
      
      if (fogLevel == 1) {
        // í¬ê·¸ë ˆë²¨ 1ë‹¨ê³„: ë°°í¬ ê°€ëŠ¥
        print('âœ… í¬ê·¸ë ˆë²¨ 1ë‹¨ê³„ - ì •ìƒ ë°°í¬ ë©”ë‰´ í‘œì‹œ');
        _showLongPressMenu();
      } else if (fogLevel == 2) {
        // í¬ê·¸ë ˆë²¨ 2ë‹¨ê³„: íšŒìƒ‰ ì˜ì—­ - ì œí•œëœ ë°°í¬
        print('âš ï¸ í¬ê·¸ë ˆë²¨ 2ë‹¨ê³„ - ì œí•œëœ ë°°í¬ ë©”ë‰´ í‘œì‹œ');
        _showRestrictedLongPressMenu();
      } else {
        // í¬ê·¸ë ˆë²¨ 3ë‹¨ê³„: ê²€ì€ ì˜ì—­ - ë°°í¬ ë¶ˆê°€
        print('ğŸš« í¬ê·¸ë ˆë²¨ 3ë‹¨ê³„ - ë°°í¬ ë¶ˆê°€ ë©”ë‰´ í‘œì‹œ');
        _showBlockedLongPressMessage();
      }
      
    } catch (e) {
      print('âŒ í¬ê·¸ë ˆë²¨ í™•ì¸ ì‹¤íŒ¨: $e');
      // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ë©”ë‰´ í‘œì‹œ
      print('ğŸ”„ ì˜¤ë¥˜ë¡œ ì¸í•´ ê¸°ë³¸ ë°°í¬ ë©”ë‰´ í‘œì‹œ');
      _showLongPressMenu();
    }
  }

  // ì œí•œëœ ë°°í¬ ë©”ë‰´ í‘œì‹œ
  void _showRestrictedLongPressMenu() {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: const Text('âš ï¸ ì œí•œëœ ì˜ì—­'),
          content: const Text(
            'ì´ ì˜ì—­ì€ íšŒìƒ‰ ì˜ì—­ì…ë‹ˆë‹¤.\n'
            'í¬ìŠ¤íŠ¸ ë°°í¬ê°€ ì œí•œë©ë‹ˆë‹¤.\n\n'
            'ì§‘, ê°€ê²Œ, í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ì˜ ë°ì€ ì˜ì—­ì—ì„œë§Œ ë°°í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text('í™•ì¸'),
            ),
          ],
        );
      },
    );
  }

  // ë°°í¬ ë¶ˆê°€ ë©”ì‹œì§€ í‘œì‹œ
  void _showBlockedLongPressMessage() {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: const Text('ğŸš« ë°°í¬ ë¶ˆê°€'),
          content: const Text(
            'ì´ ì˜ì—­ì€ ê²€ì€ ì˜ì—­ì…ë‹ˆë‹¤.\n'
            'í¬ìŠ¤íŠ¸ ë°°í¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n\n'
            'ì§‘, ê°€ê²Œ, í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ì˜ ë°ì€ ì˜ì—­ì—ì„œë§Œ ë°°í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text('í™•ì¸'),
            ),
          ],
        );
      },
    );
  }

  // í¬ê·¸ë ˆë²¨ ì—…ë°ì´íŠ¸ ë©”ì„œë“œ
  Future<void> _updateFogOfWar() async {
    if (_currentPosition == null) return;
    
    try {
      // OSM ê¸°ë°˜ í¬ê·¸ë ˆë²¨ ì—…ë°ì´íŠ¸
      await _updateOSMFogOfWar();
    } catch (e) {
      print('í¬ê·¸ë ˆë²¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: $e');
    }
  }

  // OSM ê¸°ë°˜ í¬ê·¸ë ˆë²¨ ì—…ë°ì´íŠ¸
  Future<void> _updateOSMFogOfWar() async {
    if (_currentPosition == null) return;

    try {
      // OSM í¬ê·¸ ì„œë¹„ìŠ¤ ì‚¬ìš©
      final osmFogService = OSMFogService();
      await osmFogService.updateFogOfWar(_currentPosition!);

      // í¬ê·¸ë ˆë²¨ ì—…ë°ì´íŠ¸ í›„ UI ê°±ì‹ 
      setState(() {
        // í¬ê·¸ë ˆë²¨ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹¤ì œ êµ¬í˜„ì— ë”°ë¼ ì¡°ì •)
      });
    } catch (e) {
      print('OSM í¬ê·¸ë ˆë²¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: $e');
    }
  }

  // ë§ˆì»¤ ìƒì„¸ ì •ë³´ í‘œì‹œ
  void _showMarkerDetails(MarkerModel marker) async {
    // ğŸ” ë§ˆì»¤ íƒ­ ì‹œ ë°ì´í„° í™•ì¸
    print('[MARKER_TAP_DEBUG] ë§ˆì»¤ íƒ­ë¨:');
    print('  - markerId: "${marker.markerId}"');
    print('  - postId: "${marker.postId}"');
    print('  - title: "${marker.title}"');
    print('  - postId == markerId: ${marker.postId == marker.markerId}');

    // ê±°ë¦¬ ì²´í¬
    if (_currentPosition == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')),
      );
      return;
    }

    final distance = _calculateDistance(_currentPosition!, marker.position);
    final isWithinRange = distance <= 200; // 200m ì´ë‚´
    final currentUser = FirebaseAuth.instance.currentUser;
    final isOwner = currentUser != null && marker.creatorId == currentUser.uid;

    // í¬ìŠ¤íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ì§€ í¬í•¨)
    String imageUrl = '';
    String description = '';
    int reward = 0;
    
    try {
      final postDoc = await FirebaseFirestore.instance
          .collection('posts')
          .doc(marker.postId)
          .get();
          
      if (postDoc.exists) {
        final postData = postDoc.data()!;
        final mediaUrls = postData['mediaUrl'] as List<dynamic>?;
        if (mediaUrls != null && mediaUrls.isNotEmpty) {
          imageUrl = mediaUrls.first as String;
        }
        description = postData['description'] as String? ?? '';
        reward = postData['reward'] as int? ?? 0;
      }
    } catch (e) {
      print('í¬ìŠ¤íŠ¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: $e');
    }

    // ê±°ë¦¬ê°€ ë©€ë©´ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
    if (!isWithinRange) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('${distance.toStringAsFixed(0)}m ë–¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤. 200m ì´ë‚´ë¡œ ì ‘ê·¼í•´ì£¼ì„¸ìš”.'),
          backgroundColor: Colors.orange,
          duration: Duration(seconds: 3),
        ),
      );
    }

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (BuildContext context) {
        return Container(
          height: MediaQuery.of(context).size.height * 0.85,
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              // í—¤ë”
              Container(
                padding: EdgeInsets.all(20),
                child: Row(
                  children: [
                    Expanded(
                      child: Text(
                        marker.title.replaceAll(' ê´€ë ¨ í¬ìŠ¤íŠ¸', '').replaceAll('ê´€ë ¨ í¬ìŠ¤íŠ¸', ''),
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: Colors.black87,
                        ),
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: Icon(Icons.close),
                    ),
                  ],
                ),
              ),
              
              // ë‚´ìš©
              Expanded(
                child: SingleChildScrollView(
                  padding: EdgeInsets.symmetric(horizontal: 20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // í¬ìŠ¤íŠ¸ ì„¤ëª…
                      if (description.isNotEmpty) ...[
                        Text(
                          description,
                          style: TextStyle(
                            fontSize: 16,
                            color: Colors.grey[700],
                            height: 1.5,
                          ),
                        ),
                        SizedBox(height: 20),
                      ],
                      
                      // í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ (ì˜¤ë²„ë ˆì´ ë°°ì§€ í¬í•¨)
                      if (imageUrl.isNotEmpty) ...[
                        Stack(
                          children: [
                            ClipRRect(
                              borderRadius: BorderRadius.circular(12),
                              child: Image.network(
                                imageUrl,
                                width: double.infinity,
                                height: MediaQuery.of(context).size.height * 0.6,
                                fit: BoxFit.contain,
                                errorBuilder: (context, error, stackTrace) {
                                  return Container(
                                    height: 300,
                                    decoration: BoxDecoration(
                                      color: Colors.grey[200],
                                      borderRadius: BorderRadius.circular(12),
                                    ),
                                    child: Icon(
                                      Icons.image_not_supported,
                                      size: 48,
                                      color: Colors.grey[400],
                                    ),
                                  );
                                },
                              ),
                            ),
                            // ì˜¤ë²„ë ˆì´ ë°°ì§€ë“¤
                            Positioned(
                              top: 12,
                              left: 12,
                              child: Row(
                                children: [
                                  // ìˆ˜ë ¹ ê°€ëŠ¥/ë²”ìœ„ ë°– ë°°ì§€
                                  Container(
                                    padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                                    decoration: BoxDecoration(
                                      color: isWithinRange ? Colors.green : Colors.grey,
                                      borderRadius: BorderRadius.circular(16),
                                      boxShadow: [
                                        BoxShadow(
                                          color: Colors.black.withOpacity(0.3),
                                          blurRadius: 4,
                                          offset: Offset(0, 2),
                                        ),
                                      ],
                                    ),
                                    child: Text(
                                      isWithinRange ? 'ìˆ˜ë ¹ ê°€ëŠ¥' : 'ë²”ìœ„ ë°–',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: 12,
                                        fontWeight: FontWeight.bold,
                                      ),
                                    ),
                                  ),
                                  SizedBox(width: 8),
                                  // ìˆ˜ëŸ‰ ë°°ì§€
                                  Container(
                                    padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                                    decoration: BoxDecoration(
                                      color: marker.quantity > 0 ? Colors.blue : Colors.red,
                                      borderRadius: BorderRadius.circular(16),
                                      boxShadow: [
                                        BoxShadow(
                                          color: Colors.black.withOpacity(0.3),
                                          blurRadius: 4,
                                          offset: Offset(0, 2),
                                        ),
                                      ],
                                    ),
                                    child: Text(
                                      '${marker.quantity}ê°œ ë‚¨ìŒ',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: 12,
                                        fontWeight: FontWeight.bold,
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            // ë‚´ í¬ìŠ¤íŠ¸ ë°°ì§€ (ìš°ìƒë‹¨)
                            if (isOwner)
                              Positioned(
                                top: 12,
                                right: 12,
                                child: Container(
                                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                                  decoration: BoxDecoration(
                                    color: Colors.orange,
                                    borderRadius: BorderRadius.circular(16),
                                    boxShadow: [
                                      BoxShadow(
                                        color: Colors.black.withOpacity(0.3),
                                        blurRadius: 4,
                                        offset: Offset(0, 2),
                                      ),
                                    ],
                                  ),
                                  child: Text(
                                    'ë‚´ í¬ìŠ¤íŠ¸',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                              ),
                            // í¬ì¸íŠ¸ ë°°ì§€ (ì¢Œí•˜ë‹¨)
                            if (reward > 0)
                              Positioned(
                                bottom: 12,
                                left: 12,
                                child: Container(
                                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      colors: [Colors.green[400]!, Colors.green[600]!],
                                      begin: Alignment.topLeft,
                                      end: Alignment.bottomRight,
                                    ),
                                    borderRadius: BorderRadius.circular(16),
                                    boxShadow: [
                                      BoxShadow(
                                        color: Colors.black.withOpacity(0.3),
                                        blurRadius: 4,
                                        offset: Offset(0, 2),
                                      ),
                                    ],
                                  ),
                                  child: Row(
                                    mainAxisSize: MainAxisSize.min,
                                    children: [
                                      Icon(Icons.monetization_on, color: Colors.white, size: 16),
                                      SizedBox(width: 4),
                                      Text(
                                        '+${reward}í¬ì¸íŠ¸',
                                        style: TextStyle(
                                          color: Colors.white,
                                          fontSize: 12,
                                          fontWeight: FontWeight.bold,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                          ],
                        ),
                        SizedBox(height: 20),
                      ] else if (description.isEmpty) ...[
                        // ì´ë¯¸ì§€ë„ ì—†ê³  ì„¤ëª…ë„ ì—†ìœ¼ë©´ ê¸°ë³¸ ì•„ì´ì½˜ í‘œì‹œ
                        Container(
                          height: 200,
                          decoration: BoxDecoration(
                            color: Colors.grey[100],
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Center(
                            child: Icon(
                              Icons.card_giftcard,
                              size: 64,
                              color: Colors.grey[400],
                            ),
                          ),
                        ),
                        SizedBox(height: 20),
                      ],
                      
                      
                    ],
                  ),
                ),
              ),
              
              // í•˜ë‹¨ ë²„íŠ¼
              Container(
                padding: EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: Colors.white,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.05),
                      blurRadius: 10,
                      offset: Offset(0, -2),
                    ),
                  ],
                ),
                child: Row(
                  children: [
                    Expanded(
                      child: OutlinedButton(
                        onPressed: () => Navigator.pop(context),
                        style: OutlinedButton.styleFrom(
                          padding: EdgeInsets.symmetric(vertical: 14),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                        child: Text('ë‹«ê¸°'),
                      ),
                    ),
                    if (isOwner) ...[
                      SizedBox(width: 12),
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () {
                            Navigator.pop(context);
                            _removeMarker(marker);
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.red,
                            padding: EdgeInsets.symmetric(vertical: 14),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          child: Text(
                            'íšŒìˆ˜í•˜ê¸°',
                            style: TextStyle(fontSize: 16, color: Colors.white, fontWeight: FontWeight.bold),
                          ),
                        ),
                      ),
                    ] else if (isWithinRange && marker.quantity > 0) ...[
                      SizedBox(width: 12),
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () {
                            Navigator.pop(context);
                            _collectPostFromMarker(marker);
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.green,
                            padding: EdgeInsets.symmetric(vertical: 14),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          child: Text(
                            'ìˆ˜ë ¹í•˜ê¸° (${marker.quantity}ê°œ)',
                            style: TextStyle(fontSize: 16, color: Colors.white, fontWeight: FontWeight.bold),
                          ),
                        ),
                      ),
                    ] else if (marker.quantity <= 0) ...[
                      SizedBox(width: 12),
                      Expanded(
                        child: ElevatedButton(
                          onPressed: null,
                          style: ElevatedButton.styleFrom(
                            padding: EdgeInsets.symmetric(vertical: 14),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          child: Text(
                            'ìˆ˜ëŸ‰ ì†Œì§„',
                            style: TextStyle(fontSize: 16),
                          ),
                        ),
                      ),
                    ],
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }


  // ë§ˆì»¤ì—ì„œ í¬ìŠ¤íŠ¸ ìˆ˜ë ¹
  Future<void> _collectPostFromMarker(MarkerModel marker) async {
    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤')),
        );
        return;
      }

      // í˜„ì¬ ìœ„ì¹˜ í™•ì¸
      if (_currentPosition == null) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('í˜„ì¬ ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')),
        );
        return;
      }

      // ë§ˆì»¤ ìˆ˜ì§‘ ê°€ëŠ¥ ê±°ë¦¬ í™•ì¸ (200m ì´ë‚´)
      final canCollect = MarkerService.canCollectMarker(
        _currentPosition!,
        LatLng(marker.position.latitude, marker.position.longitude),
      );

      if (!canCollect) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('ë§ˆì»¤ì—ì„œ 200m ì´ë‚´ë¡œ ì ‘ê·¼í•´ì£¼ì„¸ìš”')),
        );
        return;
      }

      // ìˆ˜ëŸ‰ í™•ì¸
      if (marker.quantity <= 0) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('ìˆ˜ë ¹ ê°€ëŠ¥í•œ ìˆ˜ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤')),
        );
        return;
      }

      // ğŸ” ìˆ˜ë ¹ ì‹œë„ ì „ ë°ì´í„° í™•ì¸
      print('[COLLECT_DEBUG] ìˆ˜ë ¹ ì‹œë„:');
      print('  - markerId: "${marker.markerId}"');
      print('  - í˜„ì¬ postId: "${marker.postId}"');
      print('  - postId == markerId: ${marker.postId == marker.markerId}');

      // ğŸš¨ CRITICAL FIX: markerIdë¡œ ì‹¤ì œ ë§ˆì»¤ë¥¼ ì¡°íšŒí•´ì„œ ì˜¬ë°”ë¥¸ postId ê°€ì ¸ì˜¤ê¸°
      if (marker.postId == marker.markerId || marker.postId.isEmpty) {
        print('[COLLECT_FIX] postIdê°€ ì˜ëª»ë¨. markerIdë¡œ ì‹¤ì œ ë§ˆì»¤ ì¡°íšŒ ì¤‘...');

        try {
          final markerDoc = await FirebaseFirestore.instance
              .collection('markers')
              .doc(marker.markerId)
              .get();

          if (markerDoc.exists && markerDoc.data() != null) {
            final markerData = markerDoc.data()!;
            final realPostId = markerData['postId'] as String?;

            print('[COLLECT_FIX] ì‹¤ì œ ë§ˆì»¤ ë°ì´í„°ì—ì„œ postId ë°œê²¬: "$realPostId"');

            if (realPostId != null && realPostId.isNotEmpty && realPostId != marker.markerId) {
              print('[COLLECT_FIX] ì˜¬ë°”ë¥¸ postIdë¡œ ìˆ˜ë ¹ ì§„í–‰: $realPostId');
              await PostService().collectPost(
                postId: realPostId,
                userId: user.uid,
              );
            } else {
              throw Exception('ë§ˆì»¤ì—ì„œ ìœ íš¨í•œ postIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
          } else {
            throw Exception('ë§ˆì»¤ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${marker.markerId}');
          }
        } catch (e) {
          print('[COLLECT_FIX] ë§ˆì»¤ ì¡°íšŒ ì‹¤íŒ¨: $e');
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text('ë§ˆì»¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $e')),
          );
          return;
        }
      } else {
        print('[COLLECT_DEBUG] ê¸°ì¡´ postId ì‚¬ìš©: ${marker.postId}');
      await PostService().collectPost(
        postId: marker.postId,
        userId: user.uid,
      );
      }

      // í¬ì¸íŠ¸ ë³´ìƒ ì •ë³´ì™€ í•¨ê»˜ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
      final reward = marker.reward ?? 0;
      final message = reward > 0
          ? 'í¬ìŠ¤íŠ¸ë¥¼ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤! ğŸ‰\n${reward}í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! (${marker.quantity - 1}ê°œ ë‚¨ìŒ)'
          : 'í¬ìŠ¤íŠ¸ë¥¼ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤! (${marker.quantity - 1}ê°œ ë‚¨ìŒ)';

      Navigator.of(context).pop(); // ë‹¤ì´ì–¼ë¡œê·¸ ë¨¼ì € ë‹«ê¸°
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.green,
          duration: const Duration(seconds: 3),
        ),
      );
      
      // ìˆ˜ë ¹ ì™„ë£Œ í›„ ì¦‰ì‹œ ë§ˆì»¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      print('ğŸ”„ ë§ˆì»¤ ìˆ˜ë ¹ ì™„ë£Œ - ë§ˆì»¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
      
      // 1. ë¡œì»¬ì—ì„œ ê°™ì€ í¬ìŠ¤íŠ¸ì˜ ëª¨ë“  ë§ˆì»¤ ì¦‰ì‹œ ì œê±° (UI ë°˜ì‘ì„±)
      setState(() {
        final postId = marker.postId;
        final removedCount = _markers.where((m) => m.postId == postId).length;
        _markers.removeWhere((m) => m.postId == postId);
        print('ğŸ—‘ï¸ ê°™ì€ í¬ìŠ¤íŠ¸ì˜ ëª¨ë“  ë§ˆì»¤ ì œê±°: ${marker.title} (${removedCount}ê°œ ë§ˆì»¤ ì œê±°ë¨)');
        print('   - postId: $postId');
        _updateMarkers(); // í´ëŸ¬ìŠ¤í„° ì¬ê³„ì‚°
      });
      
      // 2. ì„œë²„ì—ì„œ ì‹¤ì œ ë§ˆì»¤ ìƒíƒœ í™•ì¸ ë° ë™ê¸°í™”
      await Future.delayed(const Duration(milliseconds: 500));
      await _updatePostsBasedOnFogLevel();
      _updateReceivablePosts(); // ìˆ˜ë ¹ ê°€ëŠ¥ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      
      print('âœ… ë§ˆì»¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');

      // ë©”ì¸ ìŠ¤í¬ë¦°ì˜ í¬ì¸íŠ¸ ìƒˆë¡œê³ ì¹¨ (GlobalKey ì‚¬ìš©)
      try {
        final mainScreenState = MapScreen.mapKey.currentState;
        if (mainScreenState != null) {
          // MainScreenì— í¬ì¸íŠ¸ ìƒˆë¡œê³ ì¹¨ ë©”ì„œë“œê°€ ìˆë‹¤ë©´ í˜¸ì¶œ
          debugPrint('ğŸ“± ë©”ì¸ ìŠ¤í¬ë¦° í¬ì¸íŠ¸ ìƒˆë¡œê³ ì¹¨ ìš”ì²­');
        }
      } catch (e) {
        debugPrint('âš ï¸ ë©”ì¸ ìŠ¤í¬ë¦° í¬ì¸íŠ¸ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: $e');
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('ì˜¤ë¥˜: $e')),
      );
    }
  }

  void _updateMarkers() {
    print('ğŸ”§ _updateMarkers í˜¸ì¶œë¨ - _markers ê°œìˆ˜: ${_markers.length}');

    // MarkerModelì„ ìƒˆë¡œìš´ í´ëŸ¬ìŠ¤í„°ë§ ì‹œìŠ¤í…œìš©ìœ¼ë¡œ ë³€í™˜
    _visibleMarkerModels = _markers.map((marker) => ClusterMarkerModel(
      markerId: marker.markerId,
      position: marker.position,
    )).toList();

    // ìƒˆë¡œìš´ í´ëŸ¬ìŠ¤í„°ë§ ì‹œìŠ¤í…œ ì ìš©
    _rebuildClusters();
    
    // ë§ˆì»¤ ì—…ë°ì´íŠ¸ ì‹œ ìˆ˜ë ¹ ê°€ëŠ¥ ê°œìˆ˜ë„ ì—…ë°ì´íŠ¸
    _updateReceivablePosts();
  }

  // LatLng -> í™”ë©´ ì¢Œí‘œ ë³€í™˜ í•¨ìˆ˜
  Offset _latLngToScreen(LatLng ll) {
    return latLngToScreenWebMercator(
      ll, 
      mapCenter: _mapCenter, 
      zoom: _mapZoom, 
      viewSize: _lastMapSize,
    );
  }

  // ìƒˆë¡œìš´ í´ëŸ¬ìŠ¤í„°ë§ ì‹œìŠ¤í…œ - ê·¼ì ‘ ê¸°ë°˜
  void _rebuildClusters() {
    if (_visibleMarkerModels.isEmpty) {
      setState(() {
        _clusteredMarkers = [];
      });
      return;
    }

    final thresholdPx = clusterThresholdPx(_mapZoom);
    
    // ê·¼ì ‘ í´ëŸ¬ìŠ¤í„°ë§ ìˆ˜í–‰
    final buckets = buildProximityClusters(
      source: _visibleMarkerModels,
      toScreen: _latLngToScreen,
      thresholdPx: thresholdPx,
    );

    final markers = <Marker>[];
    
    for (final bucket in buckets) {
      if (!bucket.isCluster) {
        // ë‹¨ì¼ ë§ˆì»¤
        final marker = bucket.single!;
        final isSuper = _isSuperMarker(marker);
        final imagePath = isSuper ? 'assets/images/ppam_super.png' : 'assets/images/ppam_work.png';
        final imageSize = isSuper ? 36.0 : 31.0;
        
        // ì›ë³¸ MarkerModelì—ì„œ creatorId ê°€ì ¸ì˜¤ê¸°
        final originalMarker = _markers.firstWhere(
          (m) => m.markerId == marker.markerId,
          orElse: () => throw Exception('Marker not found'),
        );
        
      markers.add(
        Marker(
            key: ValueKey('single_${marker.markerId}'),
          point: marker.position,
          width: 35,
          height: 35,
            child: SingleMarkerWidget(
              imagePath: imagePath,
              size: imageSize,
              isSuper: isSuper,
              userId: originalMarker.creatorId,
              onTap: () => _onTapSingleMarker(marker),
            ),
          ),
        );
      } else {
        // í´ëŸ¬ìŠ¤í„° ë§ˆì»¤
        final rep = bucket.representative!;
        markers.add(
          Marker(
            key: ValueKey('cluster_${rep.markerId}_${bucket.items!.length}'),
            point: rep.position,
            width: 40,
            height: 40,
            child: GestureDetector(
              onTap: () => _zoomIntoCluster(bucket),
              child: SimpleClusterDot(count: bucket.items!.length),
          ),
        ),
      );
      }
    }

    setState(() {
      _clusteredMarkers = markers;
    });

    print('ğŸ”§ ê·¼ì ‘ í´ëŸ¬ìŠ¤í„°ë§ ì™„ë£Œ (ì¤Œ ${_mapZoom.toStringAsFixed(1)}, ì„ê³„ê°’ ${thresholdPx.toInt()}px): ${buckets.length}ê°œ ê·¸ë£¹, ${markers.length}ê°œ ë§ˆì»¤');
  }

  // ìŠˆí¼ ë§ˆì»¤ì¸ì§€ í™•ì¸
  bool _isSuperMarker(ClusterMarkerModel marker) {
    // ì›ë³¸ MarkerModelì—ì„œ reward í™•ì¸
    final originalMarker = _markers.firstWhere(
      (m) => m.markerId == marker.markerId,
      orElse: () => throw Exception('Marker not found'),
    );
    final markerReward = originalMarker.reward ?? 0;
    return markerReward >= AppConsts.superRewardThreshold;
  }

  // ë‹¨ì¼ ë§ˆì»¤ íƒ­ ì²˜ë¦¬
  void _onTapSingleMarker(ClusterMarkerModel marker) {
    // ê¸°ì¡´ MarkerModelì„ ì°¾ì•„ì„œ ìƒì„¸ ì •ë³´ í‘œì‹œ
    final originalMarker = _markers.firstWhere(
      (m) => m.markerId == marker.markerId,
      orElse: () => throw Exception('Marker not found'),
    );
    _showMarkerDetails(originalMarker);
  }

  // í´ëŸ¬ìŠ¤í„° íƒ­ ì‹œ í™•ëŒ€
  void _zoomIntoCluster(ClusterOrMarker cluster) {
    final rep = cluster.representative!;
    final targetZoom = (_mapZoom + 1.5).clamp(14.0, 16.0); // ì•±ì˜ ì¤Œ ë²”ìœ„ ë‚´ì—ì„œ
    _mapController?.move(rep.position, targetZoom);
  }




  Future<void> _collectMarker(MarkerModel marker) async {
    // TODO: ìƒˆë¡œìš´ êµ¬ì¡°ì— ë§ê²Œ êµ¬í˜„ ì˜ˆì •
    print('ë§ˆì»¤ ìˆ˜ì§‘: ${marker.title}');
  }

  void _showMarkerDetail(MarkerModel marker) {
    // TODO: ìƒˆë¡œìš´ êµ¬ì¡°ì— ë§ê²Œ êµ¬í˜„ ì˜ˆì •
    print('ë§ˆì»¤ ìƒì„¸: ${marker.title}');
  }

  // ë§ˆì»¤ íšŒìˆ˜ (ì‚­ì œ)
  Future<void> _removeMarker(MarkerModel marker) async {
    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) {
        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤')),
        );
        return;
      }

      // ë°°í¬ì í™•ì¸
      if (marker.creatorId != user.uid) {
        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('ìì‹ ì´ ë°°í¬í•œ í¬ìŠ¤íŠ¸ë§Œ íšŒìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤')),
        );
        return;
      }

      debugPrint('');
      debugPrint('ğŸŸ¢ğŸŸ¢ğŸŸ¢ [map_screen] íšŒìˆ˜ ë²„íŠ¼ í´ë¦­ - ë§ˆì»¤ ì •ë³´ ğŸŸ¢ğŸŸ¢ğŸŸ¢');
      debugPrint('ğŸŸ¢ marker.markerId: ${marker.markerId}');
      debugPrint('ğŸŸ¢ marker.postId: ${marker.postId}');
      debugPrint('ğŸŸ¢ PostService().recallMarker() í˜¸ì¶œ ì‹œì‘...');
      debugPrint('');

      // ê°œë³„ ë§ˆì»¤ íšŒìˆ˜ (í¬ìŠ¤íŠ¸ì™€ ë‹¤ë¥¸ ë§ˆì»¤ëŠ” ìœ ì§€)
      // await PostService().recallMarker(marker.markerId); // TODO: ë©”ì†Œë“œ êµ¬í˜„ í•„ìš”

      debugPrint('');
      debugPrint('ğŸŸ¢ [map_screen] PostService().recallMarker() ì™„ë£Œ');
      debugPrint('ğŸŸ¢ğŸŸ¢ğŸŸ¢ ========================================== ğŸŸ¢ğŸŸ¢ğŸŸ¢');
      debugPrint('');

      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('ë§ˆì»¤ë¥¼ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤')),
      );
      
      // âŒ Navigator.of(context).pop() ì œê±° - ë²„íŠ¼ì—ì„œ ì´ë¯¸ ë‹«ìŒ
      _updatePostsBasedOnFogLevel(); // ë§ˆì»¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('í¬ìŠ¤íŠ¸ íšŒìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e')),
      );
    }
  }

  // í´ë¼ì´ì–¸íŠ¸ì‚¬ì´ë“œ í•„í„°ë§ ì œê±°ë¨ - ì„œë²„ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬
  // bool _matchesFilter(PostModel post) { ... } // ì œê±°ë¨


  void _showPostDetail(PostModel post) {
    final currentUserId = FirebaseAuth.instance.currentUser?.uid;
    final isOwner = post.creatorId == currentUserId;
    
    showDialog(
      context: context,
      builder: (context) => FutureBuilder<Map<String, dynamic>?>(
        future: isOwner ? null : UserService().getUserById(post.creatorId),
        builder: (context, snapshot) {
          String creatorInfo = isOwner ? 'ë³¸ì¸' : post.creatorName;
          String creatorEmail = '';
          
          if (!isOwner && snapshot.hasData && snapshot.data != null) {
            creatorEmail = snapshot.data!['email'] ?? '';
          }
          
          return AlertDialog(
        title: Text(post.title),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
            Text('ë¦¬ì›Œë“œ: ${post.reward}ì›'),
                SizedBox(height: 8),
            Text('ì„¤ëª…: ${post.description}'),
                SizedBox(height: 8),
            Text('ê¸°ë³¸ ë§Œë£Œì¼: ${post.defaultExpiresAt.toString().split(' ')[0]}'),
                SizedBox(height: 8),
            if (isOwner)
                  Text('ë°°í¬ì: ë³¸ì¸', style: TextStyle(color: Colors.blue, fontWeight: FontWeight.bold))
                else ...[
                  Text('ë°°í¬ì: $creatorInfo', style: TextStyle(color: Colors.grey[700], fontWeight: FontWeight.w500)),
                  if (creatorEmail.isNotEmpty) ...[
                    SizedBox(height: 4),
                    Text('ì´ë©”ì¼: $creatorEmail', style: TextStyle(color: Colors.grey[600], fontSize: 12)),
                  ],
                ],
            ],
          ),
          actions: [
            TextButton(
            onPressed: () => Navigator.pop(context),
              child: const Text('ë‹«ê¸°'),
            ),
          if (isOwner)
              TextButton(
                onPressed: () {
                Navigator.pop(context);
                _removePost(post); // Only owner can remove
              },
              child: const Text('íšŒìˆ˜', style: TextStyle(color: Colors.red)),
            )
          else
              TextButton(
                onPressed: () {
                Navigator.pop(context);
                _collectPost(post); // Others can collect
              },
              child: const Text('ìˆ˜ì§‘'),
            ),
        ],
          );
        },
      ),
    );
  }

  Future<void> _collectPost(PostModel post) async {
    try {
      await PostService().collectPost(
        postId: post.postId, 
        userId: FirebaseAuth.instance.currentUser!.uid
      );
      // ğŸš€ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë¯€ë¡œ ë³„ë„ ìƒˆë¡œê³ ì¹¨ ë¶ˆí•„ìš”
      // _loadPosts(forceRefresh: true); // í¬ìŠ¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨

      // íš¨ê³¼ìŒ/ì§„ë™
      await _playReceiveEffects(1);

      // ìºëŸ¬ì…€ íŒì—…ìœ¼ë¡œ í¬ìŠ¤íŠ¸ ë‚´ìš© í‘œì‹œ
      await _showPostReceivedCarousel([post]);

    } catch (e) {
        ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('í¬ìŠ¤íŠ¸ ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e')),
      );
    }
  }

  Future<void> _removePost(PostModel post) async {
    try {
      // í¬ìŠ¤íŠ¸ íšŒìˆ˜ (ë§ˆì»¤ë„ í•¨ê»˜ íšŒìˆ˜ ì²˜ë¦¬ë¨)
      await PostService().recallPost(post.postId);
      // ğŸš€ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë¯€ë¡œ ë³„ë„ ìƒˆë¡œê³ ì¹¨ ë¶ˆí•„ìš”
      // _loadPosts(forceRefresh: true); // í¬ìŠ¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('í¬ìŠ¤íŠ¸ë¥¼ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤!')),
          );
      } catch (e) {
        ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('í¬ìŠ¤íŠ¸ íšŒìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e')),
      );
    }
  }

  // í¬ìŠ¤íŠ¸ ìˆ˜ë ¹ ìºëŸ¬ì…€ íŒì—…
  Future<void> _showPostReceivedCarousel(List<PostModel> posts) async {
    if (posts.isEmpty) return;

    // í™•ì¸ ìƒíƒœ ì¶”ì 
    final confirmedPosts = <String>{};
    final postService = PostService();
    final currentUserId = FirebaseAuth.instance.currentUser?.uid;
    
    if (currentUserId == null) return;

    final totalReward = posts.fold(0, (sum, post) => sum + (post.reward ?? 0));
    
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      isDismissible: true, // ë’¤ë¡œê°€ê¸°/ì™¸ë¶€ í„°ì¹˜ë¡œ ë‹«ì„ ìˆ˜ ìˆìŒ (ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ë¡œ ì´ë™)
      backgroundColor: Colors.transparent,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => Container(
          height: MediaQuery.of(context).size.height * 0.8,
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
        child: Column(
          children: [
            // ìƒë‹¨ í—¤ë”
            Container(
              padding: EdgeInsets.all(20),
              child: Column(
                children: [
                  Icon(Icons.check_circle, color: Colors.green, size: 48),
                  SizedBox(height: 8),
                  Text(
                    '${posts.length}ê°œ í¬ìŠ¤íŠ¸ ìˆ˜ë ¹ë¨ (í™•ì¸ ëŒ€ê¸°)',
                    style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                  ),
                  if (totalReward > 0) ...[
                    SizedBox(height: 4),
                    Text(
                      'ì´ +${totalReward}í¬ì¸íŠ¸',
                      style: TextStyle(
                        fontSize: 16, 
                        color: Colors.green, 
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ],
              ),
            ),
            
            // ìºëŸ¬ì…€ ì˜ì—­
            Expanded(
              child: PageView.builder(
                itemCount: posts.length,
                itemBuilder: (context, index) {
                  final post = posts[index];
                  final isConfirmed = confirmedPosts.contains(post.postId);
                  
                  return GestureDetector(
                    onTap: () async {
                      if (isConfirmed) return; // ì´ë¯¸ í™•ì¸í•œ í¬ìŠ¤íŠ¸ëŠ” ë¬´ì‹œ
                      
                      try {
                        // ë©±ë“± IDë¡œ ì§ì ‘ ì¡°íšŒ
                        final collectionId = '${post.postId}_$currentUserId';
                        final collectionDoc = await FirebaseFirestore.instance
                            .collection('post_collections')
                            .doc(collectionId)
                            .get();
                        
                        if (!collectionDoc.exists) {
                          if (!mounted) return;
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(content: Text('ìˆ˜ë ¹ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')),
                          );
                          return;
                        }
                        
                        final collectionData = collectionDoc.data()!;
                        final creatorId = collectionData['postCreatorId'] ?? '';
                        final reward = collectionData['reward'] ?? 0;
                        
                        // í¬ìŠ¤íŠ¸ í™•ì¸ ì²˜ë¦¬
                        // await postService.confirmPost( // TODO: confirmPost ë©”ì†Œë“œ êµ¬í˜„
                        //   collectionId: collectionId,
                        //   userId: currentUserId,
                        //   postId: post.postId,
                        //   creatorId: creatorId,
                        //   reward: reward,
                        // );
                        
                        // í™•ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
                        setState(() {
                          confirmedPosts.add(post.postId);
                        });
                        
                        // í”¼ë“œë°±
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(
                            content: Text('âœ… í¬ìŠ¤íŠ¸ í™•ì¸ ì™„ë£Œ! +${reward}í¬ì¸íŠ¸'),
                            backgroundColor: Colors.green,
                            duration: Duration(seconds: 1),
                          ),
                        );
                      } catch (e) {
                        debugPrint('í¬ìŠ¤íŠ¸ í™•ì¸ ì‹¤íŒ¨: $e');
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(content: Text('í¬ìŠ¤íŠ¸ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')),
                        );
                      }
                    },
                    child: _buildPostCarouselPage(post, index + 1, posts.length, isConfirmed),
                  );
                },
              ),
            ),
            
            // í•˜ë‹¨ ì¸ë””ì¼€ì´í„° + ë²„íŠ¼
            Container(
              padding: EdgeInsets.all(20),
              child: Column(
                children: [
                  // í˜ì´ì§€ ì¸ë””ì¼€ì´í„°
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: List.generate(posts.length, (index) {
                      final post = posts[index];
                      final isConfirmed = confirmedPosts.contains(post.postId);
                      return Container(
                        width: 8,
                        height: 8,
                        margin: EdgeInsets.symmetric(horizontal: 4),
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          color: isConfirmed ? Colors.green : Colors.grey[300],
                        ),
                      );
                    }),
                  ),
                  SizedBox(height: 12),
                  // í™•ì¸ ìƒíƒœ í‘œì‹œ
                  Text(
                    '${confirmedPosts.length}/${posts.length} í™•ì¸ ì™„ë£Œ',
                    style: TextStyle(
                      fontSize: 14,
                      color: Colors.grey[600],
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  SizedBox(height: 16),
                  
                  // í•­ìƒ í‘œì‹œë˜ëŠ” ë²„íŠ¼ë“¤
                  Row(
                    children: [
                      Expanded(
                        child: OutlinedButton.icon(
                          onPressed: () {
                            Navigator.pop(context); // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
                            // ì¸ë°•ìŠ¤ë¡œ ì´ë™
                            if (widget.onNavigateToInbox != null) {
                              widget.onNavigateToInbox!();
                            }
                          },
                          icon: Icon(Icons.inbox),
                          label: Text('ì¸ë°•ìŠ¤ ë³´ê¸°'),
                          style: OutlinedButton.styleFrom(
                            padding: EdgeInsets.symmetric(vertical: 14),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                        ),
                      ),
                      SizedBox(width: 12),
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () => Navigator.pop(context),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.blue[600],
                            padding: EdgeInsets.symmetric(vertical: 14),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          child: Text(
                            'ë‚˜ì¤‘ì— í™•ì¸',
                            style: TextStyle(fontSize: 15, color: Colors.white, fontWeight: FontWeight.bold),
                          ),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ],
        ),
        ),
      ),
    );
  }

  // ìºëŸ¬ì…€ ê°œë³„ í˜ì´ì§€ ìœ„ì ¯
  Widget _buildPostCarouselPage(PostModel post, int currentIndex, int totalCount, bool isConfirmed) {
    return SingleChildScrollView(
      padding: EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // ì§„í–‰ë¥  ë° ìƒíƒœ í‘œì‹œ
          Row(
            children: [
              Text(
                '$currentIndex/$totalCount',
                style: TextStyle(
                  color: Colors.grey[600],
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                ),
              ),
              SizedBox(width: 8),
              Container(
                padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: isConfirmed ? Colors.green : Colors.orange,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Text(
                  isConfirmed ? 'âœ“ í™•ì¸ì™„ë£Œ' : 'í„°ì¹˜í•˜ì—¬ í™•ì¸',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 11,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
              Spacer(),
              if (totalCount > 1)
                Text(
                  'ğŸ‘ˆ ìŠ¤ì™€ì´í”„',
                  style: TextStyle(
                    color: Colors.grey[500],
                    fontSize: 12,
                  ),
                ),
            ],
          ),
          
          SizedBox(height: 20),
          
          // í¬ìŠ¤íŠ¸ ì œëª©
          Text(
            post.title,
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: Colors.black87,
            ),
          ),
          
          SizedBox(height: 12),
          
          // í¬ìŠ¤íŠ¸ ì„¤ëª…
          if (post.description.isNotEmpty) ...[
            Text(
              post.description,
              style: TextStyle(
                fontSize: 16,
                color: Colors.grey[700],
                height: 1.5,
              ),
            ),
            SizedBox(height: 20),
          ],
          
          // í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€
          if (post.mediaUrl.isNotEmpty) ...[
            ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: Image.network(
                post.mediaUrl.first,
                width: double.infinity,
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    height: 200,
                    decoration: BoxDecoration(
                      color: Colors.grey[200],
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Icon(
                      Icons.image_not_supported,
                      size: 48,
                      color: Colors.grey[400],
                    ),
                  );
                },
              ),
            ),
            SizedBox(height: 20),
          ],
          
          // í¬ì¸íŠ¸ ì •ë³´
          Container(
            padding: EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green[50],
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green[200]!),
            ),
            child: Row(
              children: [
                Icon(Icons.monetization_on, color: Colors.green, size: 24),
                SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'í¬ì¸íŠ¸ ì§€ê¸‰',
                      style: TextStyle(
                        color: Colors.green[700],
                        fontWeight: FontWeight.w600,
                        fontSize: 14,
                      ),
                    ),
                    Text(
                      '+${post.reward ?? 0}í¬ì¸íŠ¸',
                      style: TextStyle(
                        color: Colors.green[700],
                        fontWeight: FontWeight.bold,
                        fontSize: 18,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
          
          // í™•ì¸ ì•ˆë‚´ (í™•ì¸ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ)
          if (!isConfirmed) ...[
            SizedBox(height: 16),
