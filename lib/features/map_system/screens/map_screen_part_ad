                Expanded(
                    child: SingleChildScrollView(
                      scrollDirection: Axis.horizontal,
                      child: Row(
                        children: [
                          // ë‚´ í¬ìŠ¤íŠ¸ í•„í„°
                          _buildFilterChip(
                            label: 'ë‚´ í¬ìŠ¤íŠ¸',
                    selected: _showMyPostsOnly,
                    onSelected: (selected) {
                      setState(() {
                        _showMyPostsOnly = selected;
                                if (selected) {
                                  _showCouponsOnly = false;
                                  _showUrgentOnly = false;
                                }
                      });
                      _updatePostsBasedOnFogLevel();
                    },
                            selectedColor: Colors.blue,
                            icon: Icons.person,
                          ),
                          const SizedBox(width: 6),
                          
                // ì¿ í° í•„í„°
                          _buildFilterChip(
                            label: 'ì¿ í°',
                    selected: _showCouponsOnly,
                    onSelected: (selected) {
                      setState(() {
                        _showCouponsOnly = selected;
                                if (selected) {
                                  _showMyPostsOnly = false;
                                  _showUrgentOnly = false;
                                }
                      });
                      _updatePostsBasedOnFogLevel();
                    },
                            selectedColor: Colors.green,
                            icon: Icons.card_giftcard,
                          ),
                          const SizedBox(width: 6),
                          
                          // ë§ˆê°ì„ë°• í•„í„°
                          _buildFilterChip(
                            label: 'ë§ˆê°ì„ë°•',
                            selected: _showUrgentOnly,
                            onSelected: (selected) {
                              setState(() {
                                _showUrgentOnly = selected;
                                if (selected) {
                                  _showMyPostsOnly = false;
                                  _showCouponsOnly = false;
                                }
                              });
                              _updatePostsBasedOnFogLevel();
                            },
                            selectedColor: Colors.orange,
                            icon: Icons.access_time_filled,
                          ),
                          const SizedBox(width: 6),
                          
                          // ì¸ì¦ í•„í„°
                          _buildFilterChip(
                            label: 'ì¸ì¦',
                            selected: _showVerifiedOnly,
                            onSelected: (selected) {
                              setState(() {
                                _showVerifiedOnly = selected;
                                if (selected) _showUnverifiedOnly = false; // ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ
                              });
                              _updatePostsBasedOnFogLevel();
                            },
                            selectedColor: Colors.blue,
                            icon: Icons.verified,
                          ),
                          const SizedBox(width: 6),
                          
                          // ë¯¸ì¸ì¦ í•„í„°
                          _buildFilterChip(
                            label: 'ë¯¸ì¸ì¦',
                            selected: _showUnverifiedOnly,
                            onSelected: (selected) {
                              setState(() {
                                _showUnverifiedOnly = selected;
                                if (selected) _showVerifiedOnly = false; // ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ
                              });
                              _updatePostsBasedOnFogLevel();
                            },
                            selectedColor: Colors.grey,
                            icon: Icons.work_outline,
                          ),
                        ],
                      ),
                    ),
                  ),
                  
                   const SizedBox(width: 8),
                  
                // í•„í„° ì´ˆê¸°í™” ë²„íŠ¼
                Container(
                  decoration: BoxDecoration(
                      color: Colors.grey[100],
                      borderRadius: BorderRadius.circular(12),
               ),
                  child: IconButton(
                    onPressed: _resetFilters,
                    icon: const Icon(Icons.refresh, color: Colors.grey),
                      iconSize: 18,
                      padding: const EdgeInsets.all(4),
                      constraints: const BoxConstraints(
                        minWidth: 32,
                        minHeight: 32,
                      ),
                  ),
                ),
              ],
              ),
            ),
          ),
          // Mock ìœ„ì¹˜ í† ê¸€ ë²„íŠ¼ (ìš°ìƒë‹¨)
          Positioned(
            top: 10,
            right: 16,
            child: Container(
              decoration: BoxDecoration(
                color: _isMockModeEnabled ? Colors.purple : Colors.white,
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 4,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
              child: IconButton(
                onPressed: _toggleMockMode,
                icon: Icon(
                  Icons.location_searching,
                  color: _isMockModeEnabled ? Colors.white : Colors.purple,
                ),
                iconSize: 20,
              ),
            ),
          ),
          // ìœ„ì¹˜ ì´ë™ ë²„íŠ¼ë“¤ (ìš°í•˜ë‹¨)
          Positioned(
            bottom: 80,
            right: 16,
            child: Column(
              children: [
                // ì§‘ ë²„íŠ¼
                Container(
                  margin: const EdgeInsets.only(bottom: 8),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 8,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: IconButton(
                    onPressed: _homeLocation != null ? _moveToHome : null,
                    icon: Icon(
                      Icons.home, 
                      color: _homeLocation != null ? Colors.green : Colors.grey,
                    ),
                    iconSize: 24,
                  ),
                ),
                // ì¼í„° ë²„íŠ¼
                Container(
                  margin: const EdgeInsets.only(bottom: 8),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 8,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: IconButton(
                    onPressed: _workLocations.isNotEmpty ? _moveToWorkplace : null,
                    icon: Icon(
                      Icons.work, 
                      color: _workLocations.isNotEmpty ? Colors.orange : Colors.grey,
                    ),
                    iconSize: 24,
                  ),
                ),
                // í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼
                Container(
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 8,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: IconButton(
                    onPressed: () async {
                      try {
                        await _getCurrentLocation();
                      } catch (e) {
                        print('í˜„ìœ„ì¹˜ ë²„íŠ¼ ì˜¤ë¥˜: $e');
                      }
                    },
                    icon: const Icon(Icons.my_location, color: Colors.blue),
                    iconSize: 24,
                  ),
                ),
              ],
            ),
          ),
          // Mock ìœ„ì¹˜ í™”ì‚´í‘œ ì»¨íŠ¸ë¡¤ëŸ¬ (ì™¼ìª½í•˜ë‹¨)
          if (_isMockControllerVisible)
            Positioned(
              bottom: 80,
              left: 16,
              child: Container(
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.1),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
          ),
        ],
      ),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    // ì œëª©ê³¼ ë‹«ê¸° ë²„íŠ¼
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                      decoration: const BoxDecoration(
                        color: Colors.purple,
                        borderRadius: BorderRadius.only(
                          topLeft: Radius.circular(12),
                          topRight: Radius.circular(12),
                        ),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          const Icon(Icons.location_searching, color: Colors.white, size: 16),
                          const SizedBox(width: 6),
                          const Text(
                            'Mock ìœ„ì¹˜',
                            style: TextStyle(
                              fontSize: 12,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                          const SizedBox(width: 8),
                          GestureDetector(
                            onTap: _hideMockController,
                            child: const Icon(Icons.close, color: Colors.white, size: 16),
                          ),
                        ],
                      ),
                    ),
                    // í™”ì‚´í‘œ ì»¨íŠ¸ë¡¤ëŸ¬
                    Padding(
                      padding: const EdgeInsets.all(8),
                      child: Column(
                        children: [
                          // ìœ„ìª½ í™”ì‚´í‘œ
                          GestureDetector(
                            onTap: () => _moveMockPosition('up'),
                            child: Container(
                              width: 40,
                              height: 30,
                              decoration: BoxDecoration(
                                color: Colors.grey[100],
                                borderRadius: BorderRadius.circular(6),
                                border: Border.all(color: Colors.grey[300]!),
                              ),
                              child: const Icon(Icons.keyboard_arrow_up, color: Colors.grey),
                            ),
                          ),
                          const SizedBox(height: 2),
                          // ì¢Œìš° í™”ì‚´í‘œ
                          Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              GestureDetector(
                                onTap: () => _moveMockPosition('left'),
                                child: Container(
                                  width: 30,
                                  height: 30,
                                  decoration: BoxDecoration(
                                    color: Colors.grey[100],
                                    borderRadius: BorderRadius.circular(6),
                                    border: Border.all(color: Colors.grey[300]!),
                                  ),
                                  child: const Icon(Icons.keyboard_arrow_left, color: Colors.grey),
                                ),
                              ),
                              const SizedBox(width: 2),
                              // ì¤‘ì•™ ìœ„ì¹˜ í‘œì‹œ
                              Container(
                                width: 30,
                                height: 30,
                                decoration: BoxDecoration(
                                  color: Colors.purple.withOpacity(0.1),
                                  borderRadius: BorderRadius.circular(6),
                                  border: Border.all(color: Colors.purple.withOpacity(0.3)),
                                ),
                                child: const Icon(Icons.my_location, color: Colors.purple, size: 16),
                              ),
                              const SizedBox(width: 2),
                              GestureDetector(
                                onTap: () => _moveMockPosition('right'),
                                child: Container(
                                  width: 30,
                                  height: 30,
                                  decoration: BoxDecoration(
                                    color: Colors.grey[100],
                                    borderRadius: BorderRadius.circular(6),
                                    border: Border.all(color: Colors.grey[300]!),
                                  ),
                                  child: const Icon(Icons.keyboard_arrow_right, color: Colors.grey),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 2),
                          // ì•„ë˜ìª½ í™”ì‚´í‘œ
                          GestureDetector(
                            onTap: () => _moveMockPosition('down'),
                            child: Container(
                              width: 40,
                              height: 30,
                              decoration: BoxDecoration(
                                color: Colors.grey[100],
                                borderRadius: BorderRadius.circular(6),
                                border: Border.all(color: Colors.grey[300]!),
                              ),
                              child: const Icon(Icons.keyboard_arrow_down, color: Colors.grey),
                            ),
                          ),
                        ],
                      ),
                    ),
                    // í˜„ì¬ ìœ„ì¹˜ ì •ë³´ (í´ë¦­í•˜ì—¬ ì§ì ‘ ì…ë ¥ ê°€ëŠ¥)
                    if (_mockPosition != null)
                      GestureDetector(
                        onTap: _showMockPositionInputDialog,
                        child: Container(
                          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(
                            color: Colors.grey[50],
                            borderRadius: const BorderRadius.only(
                              bottomLeft: Radius.circular(12),
                              bottomRight: Radius.circular(12),
                            ),
                          ),
                          child: Column(
                            children: [
                              Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Text(
                                    'ìœ„ë„: ${_mockPosition!.latitude.toStringAsFixed(4)}',
                                    style: const TextStyle(fontSize: 10, color: Colors.grey),
                                  ),
                                  const SizedBox(width: 4),
                                  const Icon(Icons.edit, size: 10, color: Colors.grey),
                                ],
                              ),
                              Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Text(
                                    'ê²½ë„: ${_mockPosition!.longitude.toStringAsFixed(4)}',
                                    style: const TextStyle(fontSize: 10, color: Colors.grey),
                                  ),
                                  const SizedBox(width: 4),
                                  const Icon(Icons.edit, size: 10, color: Colors.grey),
                                ],
                              ),
                            ],
                          ),
                        ),
                      ),
                  ],
                ),
              ),
            ),
          // ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ ì•„ì´ì½˜ (ì¢Œí•˜ë‹¨)
          Positioned(
            left: 16,
            bottom: 32,
            child: StreamBuilder<int>(
              stream: PostService().getUnconfirmedPostCountStream(
                FirebaseAuth.instance.currentUser?.uid ?? '',
              ),
              builder: (context, snapshot) {
                final unconfirmedCount = snapshot.data ?? 0;
                
                if (unconfirmedCount == 0) {
                  return SizedBox.shrink(); // ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ìˆ¨ê¹€
                }
                
                return Material(
                  elevation: 4,
                  borderRadius: BorderRadius.circular(28),
                  child: InkWell(
                    onTap: () async {
                      await _showUnconfirmedPostsDialog();
                    },
                    borderRadius: BorderRadius.circular(28),
                    child: Container(
                      padding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(28),
                        border: Border.all(color: Colors.orange, width: 2),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(Icons.receipt_long, color: Colors.orange, size: 24),
                          SizedBox(width: 6),
                          Container(
                            padding: EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                            decoration: BoxDecoration(
                              color: Colors.orange,
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Text(
                              '$unconfirmedCount',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 14,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
      // í¬ìŠ¤íŠ¸ ìˆ˜ë ¹ FAB
      floatingActionButton: _buildReceiveFab(),
      floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,
    );
  }

  // ìˆ˜ë ¹ ê°€ëŠ¥í•œ í¬ìŠ¤íŠ¸ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (ë§ˆì»¤ ê¸°ì¤€)
  Future<void> _updateReceivablePosts() async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    try {
      // í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ë§ˆì»¤ë“¤ ì¤‘ì—ì„œ 200m ì´ë‚´ì¸ ê²ƒë“¤ì„ ê³„ì‚°
      int receivableCount = 0;
      
      for (final marker in _markers) {
        // í˜„ì¬ ìœ„ì¹˜ê°€ nullì´ë©´ ê±´ë„ˆë›°ê¸°
        if (_currentPosition == null) continue;
        
        // ë§ˆì»¤ì™€ í˜„ì¬ ìœ„ì¹˜ ê°„ì˜ ê±°ë¦¬ ê³„ì‚°
        final distance = _calculateDistance(_currentPosition!, marker.position);
        
        // 200m ì´ë‚´ì´ê³ , ë³¸ì¸ì´ ë°°í¬í•œ ë§ˆì»¤ê°€ ì•„ë‹Œ ê²½ìš°
        if (distance <= 200 && marker.creatorId != user.uid) {
          receivableCount++;
        }
      }

      if (mounted) {
        setState(() {
          _receivablePostCount = receivableCount;
        });
      }
      
      print('ğŸ“ ìˆ˜ë ¹ ê°€ëŠ¥ ë§ˆì»¤ ê°œìˆ˜: $receivableCountê°œ (200m ì´ë‚´)');
    } catch (e) {
      print('ìˆ˜ë ¹ ê°€ëŠ¥ í¬ìŠ¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: $e');
      // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ UI ì—…ë°ì´íŠ¸
      if (mounted) {
        setState(() {
          _receivablePostCount = 0;
        });
      }
    }
  }

  // ìˆ˜ë ¹ FAB ìœ„ì ¯
  Widget _buildReceiveFab() {
    // ë°›ì„ ê²Œ ì—†ìœ¼ë©´ ì•„ì˜ˆ ìˆ¨ê¹€
    if (_receivablePostCount <= 0 && !_isReceiving) {
      return const SizedBox.shrink();
    }
    
    final enabled = _receivablePostCount > 0 && !_isReceiving;
    
    return Align(
      alignment: Alignment.bottomCenter,
      child: Padding(
        padding: const EdgeInsets.only(bottom: 24),
        child: Container(
          height: 48, // ë†’ì´ ì¤„ì„ (ê¸°ë³¸ 56ì—ì„œ 48ë¡œ)
        child: FloatingActionButton.extended(
          onPressed: enabled ? _receiveNearbyPosts : null,
          backgroundColor: enabled ? Colors.blue : Colors.grey,
          label: _isReceiving 
              ? Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    SizedBox(
                      width: 16,
                      height: 16,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                      ),
                    ),
                    SizedBox(width: 8),
                    Text('ìˆ˜ë ¹ ì¤‘...', style: TextStyle(color: Colors.white)),
                  ],
                )
              : Text(
                  enabled ? 'ëª¨ë‘ ìˆ˜ë ¹ ($_receivablePostCountê°œ)' : 'í¬ìŠ¤íŠ¸ ë°›ê¸°',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                ),
          icon: _isReceiving ? null : Icon(Icons.download, color: Colors.white),
          ),
        ),
      ),
    );
  }

  // ì£¼ë³€ ë§ˆì»¤ì—ì„œ í¬ìŠ¤íŠ¸ ìˆ˜ë ¹ ì²˜ë¦¬ (ë§ˆì»¤ ê¸°ì¤€)
  Future<void> _receiveNearbyPosts() async {
    setState(() => _isReceiving = true);
    
    // ìŠ¤ì½”í”„ ë°–ì— ë³€ìˆ˜ ì„ ì–¸ (finally ë¸”ë¡ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥)
    final actuallyReceived = <ReceiptItem>[];
    final failedToReceive = <String>[];
    final nearbyMarkers = <MarkerModel>[];
    
    try {
      final user = FirebaseAuth.instance.currentUser!;
      
      // 1. í˜„ì¬ ìœ„ì¹˜ì—ì„œ 200m ì´ë‚´ì˜ ë§ˆì»¤ë“¤ ì°¾ê¸°
      
      for (final marker in _markers) {
        if (_currentPosition == null) continue;
        
        // ë§ˆì»¤ì™€ í˜„ì¬ ìœ„ì¹˜ ê°„ì˜ ê±°ë¦¬ ê³„ì‚°
        final distance = _calculateDistance(_currentPosition!, marker.position);
        
        // 200m ì´ë‚´ì´ê³ , ë³¸ì¸ì´ ë°°í¬í•œ ë§ˆì»¤ê°€ ì•„ë‹Œ ê²½ìš°
        if (distance <= 200 && marker.creatorId != user.uid) {
          nearbyMarkers.add(marker);
        }
      }

      if (nearbyMarkers.isEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('200m ì´ë‚´ì— ìˆ˜ë ¹ ê°€ëŠ¥í•œ ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤'),
            backgroundColor: Colors.orange,
          ),
        );
        return;
      }

      // 2. ìˆ˜ë ¹ ì²˜ë¦¬ (PostService ì‚¬ìš©í•˜ì—¬ ìˆ˜ëŸ‰ ì°¨ê° í¬í•¨)

      for (final marker in nearbyMarkers) {
        try {
          // ğŸ” ìˆ˜ë ¹ ì‹œë„ ì „ ë°ì´í„° í™•ì¸ (ê°œë³„ í´ë¦­ê³¼ ë™ì¼í•œ ê²€ì¦ ë¡œì§)
          print('[BATCH_COLLECT_DEBUG] ìˆ˜ë ¹ ì‹œë„:');
          print('  - markerId: "${marker.markerId}"');
          print('  - í˜„ì¬ postId: "${marker.postId}"');
          print('  - postId == markerId: ${marker.postId == marker.markerId}');

          String actualPostId = marker.postId;
          
          // ğŸš¨ CRITICAL FIX: markerIdë¡œ ì‹¤ì œ ë§ˆì»¤ë¥¼ ì¡°íšŒí•´ì„œ ì˜¬ë°”ë¥¸ postId ê°€ì ¸ì˜¤ê¸°
          if (marker.postId == marker.markerId || marker.postId.isEmpty) {
            print('[BATCH_COLLECT_FIX] postIdê°€ ì˜ëª»ë¨. markerIdë¡œ ì‹¤ì œ ë§ˆì»¤ ì¡°íšŒ ì¤‘...');

            try {
              final markerDoc = await FirebaseFirestore.instance
                  .collection('markers')
                  .doc(marker.markerId)
                  .get();

              if (markerDoc.exists && markerDoc.data() != null) {
                final markerData = markerDoc.data()!;
                final realPostId = markerData['postId'] as String?;

                print('[BATCH_COLLECT_FIX] ì‹¤ì œ ë§ˆì»¤ ë°ì´í„°ì—ì„œ postId ë°œê²¬: "$realPostId"');

                if (realPostId != null && realPostId.isNotEmpty && realPostId != marker.markerId) {
                  actualPostId = realPostId;
                  print('[BATCH_COLLECT_FIX] ì˜¬ë°”ë¥¸ postIdë¡œ ìˆ˜ë ¹ ì§„í–‰: $actualPostId');
                } else {
                  throw Exception('ë§ˆì»¤ì—ì„œ ìœ íš¨í•œ postIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
              } else {
                throw Exception('ë§ˆì»¤ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${marker.markerId}');
              }
            } catch (e) {
              print('[BATCH_COLLECT_FIX] ë§ˆì»¤ ì¡°íšŒ ì‹¤íŒ¨: $e');
              failedToReceive.add('${marker.title} (ë§ˆì»¤ ì •ë³´ ì˜¤ë¥˜: $e)');
              continue; // ë‹¤ìŒ ë§ˆì»¤ë¡œ ì§„í–‰
            }
          } else {
            print('[BATCH_COLLECT_DEBUG] ê¸°ì¡´ postId ì‚¬ìš©: ${marker.postId}');
          }

          // ğŸ”¥ PostServiceë¥¼ í†µí•œ ì‹¤ì œ í¬ìŠ¤íŠ¸ ìˆ˜ë ¹ (ìˆ˜ëŸ‰ ì°¨ê° í¬í•¨)
          await PostService().collectPost(
            postId: actualPostId,
            userId: user.uid,
          );

          // ìˆ˜ë ¹ ê¸°ë¡ì„ receipts ì»¬ë ‰ì…˜ì—ë„ ì €ì¥
          final ref = FirebaseFirestore.instance
              .collection('receipts')
              .doc(user.uid)
              .collection('items')
              .doc(marker.markerId);

            // í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            String postImageUrl = '';
            try {
              final postDoc = await FirebaseFirestore.instance
                  .collection('posts')
                  .doc(marker.postId)
                  .get();
              if (postDoc.exists) {
                postImageUrl = postDoc.data()?['imageUrl'] ?? '';
              }
            } catch (e) {
              print('í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ ì¡°íšŒ ì‹¤íŒ¨: $e');
            }

          await ref.set({
              'markerId': marker.markerId,
              'imageUrl': postImageUrl,
              'title': marker.title,
              'receivedAt': FieldValue.serverTimestamp(),
              'confirmed': false,
              'statusBadge': 'ë¯¸ì…˜ ì¤‘',
            });
            
            actuallyReceived.add(ReceiptItem(
              markerId: marker.markerId,
              imageUrl: postImageUrl,
              title: marker.title,
              receivedAt: DateTime.now(),
              confirmed: false,
              statusBadge: 'ë¯¸ì…˜ ì¤‘',
            ));
        } catch (e) {
          // ê°œë³„ ìˆ˜ë ¹ ì‹¤íŒ¨
          failedToReceive.add('${marker.title} (ìˆ˜ë ¹ ì‹¤íŒ¨: ${e.toString()})');
        }
      }

      if (actuallyReceived.isNotEmpty) {
        // 3. íš¨ê³¼ìŒ/ì§„ë™
        await _playReceiveEffects(actuallyReceived.length);

        // 4. ìºëŸ¬ì…€ íŒì—…ìœ¼ë¡œ ìˆ˜ë ¹í•œ í¬ìŠ¤íŠ¸ë“¤ í‘œì‹œ
        final receivedPosts = <PostModel>[];
        for (final receipt in actuallyReceived) {
          // ReceiptItemì—ì„œ PostModelë¡œ ë³€í™˜
          final post = PostModel(
            postId: receipt.markerId,
            title: receipt.title,
            description: 'ìˆ˜ë ¹ ì™„ë£Œ',
            reward: 0, // ì‹¤ì œ rewardëŠ” PostServiceì—ì„œ ì²˜ë¦¬ë¨
            creatorId: '',
            creatorName: '',
            createdAt: DateTime.now(),
            defaultExpiresAt: DateTime.now().add(Duration(days: 1)),
            targetAge: [],
            targetGender: 'all',
            targetInterest: [],
            targetPurchaseHistory: [],
            mediaType: [],
            mediaUrl: receipt.imageUrl.isNotEmpty ? [receipt.imageUrl] : [],
            canRespond: false,
            canForward: false,
            canRequestReward: false,
            canUse: false,
          );
          receivedPosts.add(post);
        }
        await _showPostReceivedCarousel(receivedPosts);
      } else if (failedToReceive.isNotEmpty) {
        // ìˆ˜ë ¹í•  ìˆ˜ ìˆëŠ” í¬ìŠ¤íŠ¸ê°€ ì—†ëŠ” ê²½ìš°
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('ìˆ˜ë ¹í•  ìˆ˜ ìˆëŠ” ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤ (${failedToReceive.length}ê°œ ì‹¤íŒ¨)'),
            backgroundColor: Colors.orange,
          ),
        );
      }
    } catch (e) {
      print('ë§ˆì»¤ ìˆ˜ë ¹ ì‹¤íŒ¨: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('ë§ˆì»¤ ìˆ˜ë ¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: $e')),
      );
    } finally {
      setState(() => _isReceiving = false);
      
      // ìˆ˜ë ¹ ì™„ë£Œ í›„ ì¦‰ì‹œ ë§ˆì»¤ ìƒˆë¡œê³ ì¹¨
      print('ğŸ”„ ë°°ì¹˜ ìˆ˜ë ¹ ì™„ë£Œ - ë§ˆì»¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
      
      // 1. ë¡œì»¬ì—ì„œ ìˆ˜ë ¹í•œ í¬ìŠ¤íŠ¸ì˜ ëª¨ë“  ë§ˆì»¤ ì¦‰ì‹œ ì œê±° (UI ë°˜ì‘ì„±)
      if (actuallyReceived.isNotEmpty) {
        setState(() {
          // ìˆ˜ë ¹í•œ í¬ìŠ¤íŠ¸ IDë“¤ ìˆ˜ì§‘
          final collectedPostIds = <String>{};
          for (final receipt in actuallyReceived) {
            // markerIdë¡œ ì›ë³¸ ë§ˆì»¤ ì°¾ê¸°
            final originalMarker = nearbyMarkers.firstWhere(
              (m) => m.markerId == receipt.markerId,
              orElse: () => nearbyMarkers.first,
            );
            collectedPostIds.add(originalMarker.postId);
          }
          
          // ìˆ˜ë ¹í•œ í¬ìŠ¤íŠ¸ë“¤ì˜ ëª¨ë“  ë§ˆì»¤ ì œê±° (ê°™ì€ postIdë¥¼ ê°€ì§„ ë‹¤ë¥¸ ë§ˆì»¤ë“¤ë„ í•¨ê»˜)
          final removedCount = _markers.where((m) => collectedPostIds.contains(m.postId)).length;
          _markers.removeWhere((m) => collectedPostIds.contains(m.postId));
          print('ğŸ—‘ï¸ ìˆ˜ë ¹í•œ í¬ìŠ¤íŠ¸ë“¤ì˜ ëª¨ë“  ë§ˆì»¤ ì œê±°: ${removedCount}ê°œ');
          print('   - ìˆ˜ë ¹í•œ í¬ìŠ¤íŠ¸ IDs: $collectedPostIds');
          
          _updateMarkers(); // í´ëŸ¬ìŠ¤í„° ì¬ê³„ì‚°
        });
      }
      
      // 2. ì„œë²„ì—ì„œ ì‹¤ì œ ë§ˆì»¤ ìƒíƒœ í™•ì¸ ë° ë™ê¸°í™”
      await Future.delayed(const Duration(milliseconds: 500));
      await _updatePostsBasedOnFogLevel(); // ë§ˆì»¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      _updateReceivablePosts(); // ê°œìˆ˜ ì—…ë°ì´íŠ¸
      
      print('âœ… ë°°ì¹˜ ë§ˆì»¤ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
    }
  }

  // ìˆ˜ë ¹ íš¨ê³¼ìŒ/ì§„ë™
  Future<void> _playReceiveEffects(int count) async {
    try {
      // ì§„ë™
      if (await Vibration.hasVibrator() ?? false) {
        Vibration.vibrate(duration: 100);
      }

      // ì‚¬ìš´ë“œ (countë§Œí¼ ë°˜ë³µ)
      final player = audio.AudioPlayer();
      await player.setSource(audio.AssetSource('sounds/receive.mp3'));
      
      for (int i = 0; i < count; i++) {
        await player.resume();
        await Future.delayed(const Duration(milliseconds: 250));
        await player.stop();
        if (i < count - 1) {
          await Future.delayed(const Duration(milliseconds: 100));
        }
      }
      
      await player.dispose();
    } catch (e) {
      print('íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨: $e');
    }
  }

  /// ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
  Future<void> _showUnconfirmedPostsDialog() async {
    final currentUserId = FirebaseAuth.instance.currentUser?.uid;
    if (currentUserId == null) return;

    try {
      // ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ ëª©ë¡ ì¡°íšŒ
      final postService = PostService();
      final unconfirmedPosts = await postService.getUnconfirmedPosts(currentUserId);

      if (unconfirmedPosts.isEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤')),
        );
        return;
      }

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => Container(
          height: MediaQuery.of(context).size.height * 0.9,
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              // í—¤ë”
              Container(
                padding: EdgeInsets.all(20),
                child: Row(
                  children: [
                    Icon(Icons.receipt_long, color: Colors.orange, size: 24),
                    SizedBox(width: 8),
                    Text(
                      'ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ (${unconfirmedPosts.length}ê°œ)',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: Colors.orange[800],
                      ),
                    ),
                    Spacer(),
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: Icon(Icons.close),
                    ),
                  ],
                ),
              ),
              
              // ìºëŸ¬ì…€ ì˜ì—­
              Expanded(
                child: PageView.builder(
                  itemCount: unconfirmedPosts.length,
                  itemBuilder: (context, index) {
                    final post = unconfirmedPosts[index];
                    final title = post['postTitle'] ?? 'Unknown Title';
                    final collectedAt = post['collectedAt'] as Timestamp?;
                    final reward = post['reward'] ?? 0;
                    final collectionId = post['collectionId'] as String;
                    final postId = post['postId'] as String;
                    final creatorId = post['postCreatorId'] ?? '';
                    final imageUrls = post['imageUrls'] as List<dynamic>? ?? [];
                    final thumbnailUrls = post['thumbnailUrls'] as List<dynamic>? ?? [];
                    
                    // í‘œì‹œí•  ì´ë¯¸ì§€ URL (ì¸ë„¤ì¼ ìš°ì„ , ì—†ìœ¼ë©´ ì›ë³¸, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ null)
                    final displayImageUrl = thumbnailUrls.isNotEmpty 
                        ? thumbnailUrls.first as String?
                        : (imageUrls.isNotEmpty ? imageUrls.first as String? : null);

                    return GestureDetector(
                      onTap: () async {
                        // í„°ì¹˜í•˜ì—¬ í™•ì¸
                        await _confirmUnconfirmedPost(
                          collectionId: collectionId,
                          userId: currentUserId,
                          postId: postId,
                          creatorId: creatorId,
                          reward: reward,
                          title: title,
                        );
                      },
                      child: SingleChildScrollView(
                        padding: EdgeInsets.all(20),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            // ìƒíƒœ ë°°ì§€
                            Row(
                              children: [
                                Container(
                                  padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                                  decoration: BoxDecoration(
                                    color: Colors.orange,
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: Text(
                                    'í„°ì¹˜í•˜ì—¬ í™•ì¸',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 11,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                                Spacer(),
                                if (unconfirmedPosts.length > 1)
                                  Text(
                                    '${index + 1}/${unconfirmedPosts.length} ğŸ‘ˆ ìŠ¤ì™€ì´í”„',
                                    style: TextStyle(
                                      color: Colors.grey[500],
                                      fontSize: 12,
                                    ),
                                  ),
                              ],
                            ),
                            
                            SizedBox(height: 20),
                            
                            // í¬ìŠ¤íŠ¸ ì œëª©
                            Text(
                              title,
                              style: TextStyle(
                                fontSize: 24,
                                fontWeight: FontWeight.bold,
                                color: Colors.black87,
                              ),
                            ),
                            
                            SizedBox(height: 12),
                            
                            // ìˆ˜ë ¹ì¼ ì •ë³´
                            if (collectedAt != null) ...[
                              Row(
                                children: [
                                  Icon(Icons.access_time, size: 16, color: Colors.grey[600]),
                                  SizedBox(width: 4),
                                  Text(
                                    'ìˆ˜ë ¹ì¼: ${_formatDate(collectedAt.toDate())}',
                                    style: TextStyle(
                                      fontSize: 14,
                                      color: Colors.grey[600],
                                    ),
                                  ),
                                ],
                              ),
                              SizedBox(height: 20),
                            ],
                            
                            // í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ (ì¤‘ì•™ì— í¬ê²Œ)
                            if (displayImageUrl != null) ...[
                              ClipRRect(
                                borderRadius: BorderRadius.circular(12),
                                child: Image.network(
                                  displayImageUrl,
                                  width: double.infinity,
                                  height: 300,
                                  fit: BoxFit.cover,
                                  errorBuilder: (context, error, stackTrace) {
                                    return Container(
                                      height: 200,
                                      decoration: BoxDecoration(
                                        color: Colors.grey[200],
                                        borderRadius: BorderRadius.circular(12),
                                      ),
                                      child: Icon(
                                        Icons.image_not_supported,
                                        size: 48,
                                        color: Colors.grey[400],
                                      ),
                                    );
                                  },
                                ),
                              ),
                              SizedBox(height: 20),
                            ] else ...[
                              // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ í° ì¹´ë“œ í˜•íƒœë¡œ í…ìŠ¤íŠ¸ í‘œì‹œ
                              Container(
                                height: 200,
                                padding: EdgeInsets.all(24),
                                decoration: BoxDecoration(
                                  color: Colors.orange[50],
                                  borderRadius: BorderRadius.circular(12),
                                  border: Border.all(color: Colors.orange[200]!),
                                ),
                                child: Center(
                                  child: Column(
                                    mainAxisAlignment: MainAxisAlignment.center,
                                    children: [
                                      Icon(
                                        Icons.card_giftcard,
                                        size: 64,
                                        color: Colors.orange[400],
                                      ),
                                      SizedBox(height: 12),
                                      Text(
                                        title,
                                        style: TextStyle(
                                          color: Colors.grey[700],
                                          fontSize: 18,
                                          fontWeight: FontWeight.bold,
                                        ),
                                        textAlign: TextAlign.center,
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                              SizedBox(height: 20),
                            ],
                            
                            // í¬ì¸íŠ¸ ì •ë³´
                            Container(
                              padding: EdgeInsets.all(16),
                              decoration: BoxDecoration(
                                color: Colors.green[50],
                                borderRadius: BorderRadius.circular(12),
                                border: Border.all(color: Colors.green[200]!),
                              ),
                              child: Row(
                                children: [
                                  Icon(Icons.monetization_on, color: Colors.green, size: 24),
                                  SizedBox(width: 12),
                                  Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        'í¬ì¸íŠ¸ ì§€ê¸‰',
                                        style: TextStyle(
                                          color: Colors.green[700],
                                          fontWeight: FontWeight.w600,
                                          fontSize: 14,
                                        ),
                                      ),
                                      Text(
                                        '+${reward}í¬ì¸íŠ¸',
                                        style: TextStyle(
                                          color: Colors.green[700],
                                          fontWeight: FontWeight.bold,
                                          fontSize: 18,
                                        ),
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            ),
                            
                            SizedBox(height: 16),
                            
                            // í™•ì¸ ì•ˆë‚´
                            Container(
                              padding: EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: Colors.orange[50],
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Row(
                                children: [
                                  Icon(Icons.touch_app, size: 16, color: Colors.orange[700]),
                                  SizedBox(width: 8),
                                  Expanded(
                                    child: Text(
                                      'ì´ ì˜ì—­ì„ í„°ì¹˜í•˜ë©´ í™•ì¸í•˜ê³  í¬ì¸íŠ¸ë¥¼ ë°›ìŠµë‹ˆë‹¤',
                                      style: TextStyle(
                                        fontSize: 12,
                                        color: Colors.orange[700],
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                ),
              ),
              
              // í˜ì´ì§€ ì¸ë””ì¼€ì´í„°
              if (unconfirmedPosts.length > 1)
                Padding(
                  padding: EdgeInsets.symmetric(vertical: 8),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: List.generate(unconfirmedPosts.length, (index) {
                      return Container(
                        width: 8,
                        height: 8,
                        margin: EdgeInsets.symmetric(horizontal: 4),
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          color: Colors.orange,
                        ),
                      );
                    }),
                  ),
                ),
              
              // í•˜ë‹¨ ë²„íŠ¼
              Container(
                padding: EdgeInsets.all(20),
                child: SizedBox(
                  width: double.infinity,
                  child: OutlinedButton(
                    onPressed: () => Navigator.pop(context),
                    style: OutlinedButton.styleFrom(
                      padding: EdgeInsets.symmetric(vertical: 12),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                    ),
                    child: Text('ë‚˜ì¤‘ì— í™•ì¸í•˜ê¸°'),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
    } catch (e) {
      debugPrint('ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $e')),
      );
    }
  }

  /// ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ í™•ì¸ ì²˜ë¦¬
  Future<void> _confirmUnconfirmedPost({
    required String collectionId,
    required String userId,
    required String postId,
    required String creatorId,
    required int reward,
    required String title,
  }) async {
    try {
      final postService = PostService();
      
      // í¬ìŠ¤íŠ¸ í™•ì¸ ì²˜ë¦¬
      // await postService.confirmPost( // TODO: confirmPost ë©”ì†Œë“œ êµ¬í˜„
      //   collectionId: collectionId,
      //   userId: userId,
      //   postId: postId,
      //   creatorId: creatorId,
      //   reward: reward,
      // );

      // ì„±ê³µ ë©”ì‹œì§€
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('âœ… $title í™•ì¸ ì™„ë£Œ! +${reward}í¬ì¸íŠ¸'),
          backgroundColor: Colors.green,
          duration: Duration(seconds: 2),
        ),
      );

      // ë‹¤ì´ì–¼ë¡œê·¸ ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•´ ë‹«ê³  ë‹¤ì‹œ ì—´ê¸°
      Navigator.pop(context);
      await _showUnconfirmedPostsDialog();
      
    } catch (e) {
      debugPrint('ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ í™•ì¸ ì‹¤íŒ¨: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('í¬ìŠ¤íŠ¸ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: $e')),
      );
    }
  }

  /// ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ ì‚­ì œ ì²˜ë¦¬ (ë³´ìƒ ì—†ì´ ì œê±°)
  Future<void> _deleteUnconfirmedPost({
    required String collectionId,
    required String title,
  }) async {
    // ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: Row(
          children: [
            Icon(Icons.warning, color: Colors.red, size: 24),
            SizedBox(width: 8),
            Text('í¬ìŠ¤íŠ¸ ì‚­ì œ'),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('ì´ í¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'),
            SizedBox(height: 8),
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.red.withOpacity(0.1),
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.red.withOpacity(0.3)),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'âš ï¸ ì£¼ì˜',
                    style: TextStyle(
                      color: Colors.red[700],
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                  SizedBox(height: 4),
                  Text(
                    'â€¢ ì‚­ì œí•˜ë©´ ë³´ìƒì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤\nâ€¢ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                    style: TextStyle(
                      color: Colors.red[600],
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text('ì·¨ì†Œ'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red,
              foregroundColor: Colors.white,
            ),
            child: Text('ì‚­ì œ'),
          ),
        ],
      ),
    );

    if (confirmed != true) return;

    try {
      // post_collectionsì—ì„œ ì‚­ì œ (ë³´ìƒ ì—†ìŒ)
      await FirebaseFirestore.instance
          .collection('post_collections')
          .doc(collectionId)
          .delete();

      debugPrint('âœ… ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ ì‚­ì œ ì„±ê³µ: $collectionId');

      // ì„±ê³µ ë©”ì‹œì§€
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('ğŸ—‘ï¸ $title ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'),
          backgroundColor: Colors.grey[700],
          duration: Duration(seconds: 2),
        ),
      );

      // ë‹¤ì´ì–¼ë¡œê·¸ ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•´ ë‹«ê³  ë‹¤ì‹œ ì—´ê¸°
      Navigator.pop(context);
      await _showUnconfirmedPostsDialog();
      
    } catch (e) {
      debugPrint('âŒ ë¯¸í™•ì¸ í¬ìŠ¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('í¬ìŠ¤íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  /// ë‚ ì§œ í¬ë§·íŒ… í—¬í¼ í•¨ìˆ˜
  String _formatDate(DateTime date) {
    return '${date.year}.${date.month.toString().padLeft(2, '0')}.${date.day.toString().padLeft(2, '0')} ${date.hour.toString().padLeft(2, '0')}:${date.minute.toString().padLeft(2, '0')}';
  }


}
 
 